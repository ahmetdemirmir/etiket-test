<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fiyat Gör Etiket Bas — 27/sayfa • yüksek çözünürlük • FIX v3.2.1</title>

<!-- Icons & Libs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root{
  --bg:#f6f8fc; --card:#ffffff; --line:#e5e7eb; --ink:#0f172a; --muted:#64748b;
  --brand:#2563eb; --brand2:#38bdf8; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
header{position:sticky;top:0;z-index:5;background:#fff;color:var(--brand);display:flex;align-items:center;gap:12px;justify-content:center;padding:12px;border-bottom:1px solid #dbe2f1}
header img{height:42px}
header h1{margin:0;font-size:1.2rem;font-weight:800}
.wrap{max-width:1100px;margin:auto;padding:18px}

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px}
.control{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.input{flex:1;min-width:220px;background:#fff;border:1px solid var(--line);color:#0f172a;padding:12px;border-radius:12px;font-size:15px}
.input[readonly]{background:#f3f4f6;color:#94a3b8}
.btn{border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:.15s transform ease}
.btn:active{transform:translateY(1px)}
.btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
.btn.success{background:linear-gradient(90deg,#059669,#34d399);color:#fff}
.btn.neutral{background:#fff;border:1px solid var(--line);color:#0f172a}
.btn.danger{background:linear-gradient(90deg,#b91c1c,#ef4444);color:#fff}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#fff;color:#0b3ea9;padding:7px 10px;border-radius:999px;font-size:12px}
small.hint{display:block;color:var(--muted);margin-top:6px}

/* sonuç listesi */
.list{display:flex;flex-direction:column;gap:8px;max-height:62vh;overflow:auto;margin-top:8px}
.item{display:flex;justify-content:space-between;gap:10px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;cursor:pointer}
.item:hover{background:#f8fbff}
.item .nm{font-weight:800}
.item .bc{font-family:Arial,Helvetica,system-ui,sans-serif;color:#475569;font-size:12px}
.tag-old{border:1px solid rgba(245,158,11,.7);color:#9a3412;background:#fff7ed;border-radius:999px;padding:2px 8px;font-size:11px}

/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:80}
.modal.shown{display:flex}
.box{width:min(92vw,580px);background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 16px 40px rgba(0,0,0,.2)}
.box h3{margin:0 0 8px}
.price{font-size:32px;font-weight:900;color:#111}
.mini{font-size:12px;color:var(--muted)}
.warn{background:#fff1f2;border:1px solid #fecaca;color:#991b1b;padding:12px;border-radius:12px;font-weight:800;margin:10px 0;display:flex;gap:8px;align-items:center}
.warn i{font-size:18px}
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.barcodeBig{font-family:Arial,Helvetica,system-ui,sans-serif;font-weight:900;letter-spacing:.5px}
#mDateRow{font-weight:700;color:#b91c1c;margin-top:6px}

/* Popup: etiket önizleme */
.previewLabel{border:1px dashed #e5e7eb;border-radius:10px;padding:8px;margin-top:10px;display:flex;gap:8px;align-items:center}
.previewLabel img{height:40px}
.previewLabel .pname{font-weight:700;font-size:12px}

/* Sepet */
#mdlCart .list{max-height:60vh}
.cartRow{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px}
.cartName{font-weight:700}
.qtyCtrl{display:inline-flex;align-items:center;gap:6px}
.qtyCtrl button{border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
.cartTotal{margin-top:8px;font-weight:800}
.cartFilters{display:flex;gap:8px;margin:8px 0}

/* Toast */
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:12px 16px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .25s;z-index:120}
.toast.show{opacity:0.95}

/* PDF önizleme */
.pdfBox{width:min(95vw,920px);height:90vh;display:flex;flex-direction:column}
.pdfFrame{flex:1;border:1px solid var(--line);border-radius:8px}

/* Label preview (UI) */
#etiketler{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.etiket{background:#fff;width:280px;height: 110px;border-radius:14px;box-shadow:0 1px 6px #d7d7db55;display:flex;flex-direction:row;align-items:flex-start;padding:12px 12px 8px 6px;box-sizing:border-box;position:relative}
.etiket-logo{width:70px;height: 90px;margin-right:5px;flex-shrink:0;display:flex;align-items:flex-start;justify-content:flex-start}
.etiket-logo img{width:100%;height:100%;object-fit:contain}
.etiket-icerik{flex:1;display:flex;flex-direction:column;justify-content:space-between;height:100%}
.etiket-stokadi{font-size:13px;font-weight:500;color:#2e2e2e;line-height:1.1;min-height:36px;max-height:32px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.etiket-row{display:flex;align-items:flex-end;justify-content:flex-end;gap:4px}
.etiket-fiyat{font-size:26px;color:#e20032;font-weight:650;letter-spacing:1px;margin:0;display:flex;align-items:flex-end;gap:2px;min-width:52px;justify-content:center}
.etiket-fiyat .tlsimge{font-size:15px;margin-left:1px}
.etiket-barkod{width:72px;height:54px;display:flex;flex-direction:column;align-items:flex-end}
.etiket-barkod img{width:100%;height:44px;object-fit:contain}
.etiket-fiyat{font-variant-numeric: tabular-nums; display:flex; align-items:flex-end; justify-content:center}
.etiket-fiyat-wrap{display:flex;flex-direction:column;align-items:center;gap:2px}
.etiket-fiyat-etiket{font-size:12px;color:#111;font-weight:600;letter-spacing:.2px}
.etiket-badge{
  position:absolute; left:6px; top:6px;
  padding:2px 6px; border-radius:6px;
  font-size:11px; font-weight:800; line-height:1;
  color:#7f1d1d; background:#fee2e2; border:1px solid #fecaca;
  box-shadow:0 1px 2px rgba(0,0,0,.08);
  -webkit-print-color-adjust: exact; print-color-adjust: exact;
}
.etiket-badge i{ font-style:normal; margin-right:4px }
.old-ico{margin-left:6px; font-size:12px; display:inline-flex; align-items:center; line-height:1}
.etiket-fiyat-etiket{text-align:center}

/* Kamera katmanları */
#camSheet,#camSheetIOS{position:fixed;inset:0;background:rgba(15,23,42,.6);z-index:9999;display:none}
#camBox,#camBoxIOS{position:absolute;left:50%;top:8%;transform:translateX(-50%);width:min(96vw,720px);background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.25);overflow:hidden}
#camHead,#camHeadIOS{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #e5e7eb}
#camMount,#camMountIOS{position:relative;width:100%;height:380px;background:#000}
#camMount video,#camMountIOS video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
#camFoot,#camFootIOS{display:flex;justify-content:flex-end;gap:8px;padding:10px 14px;border-top:1px solid #e5e7eb;background:#fafafa}

/* Eski fiyat popup */
#mdlOldWarn .box{border:2px solid #fecaca}
#mdlOldWarn .warn{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}

/* Modern confirm modal */
.modal .confirmRow{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

/* === DK: Canlı Adet Butonları === */
.actions .qty-btn{ color:#fff !important; font-weight:800; border:none !important; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,.10) }
.actions .qty-btn.one{ padding:1.05rem 1.25rem !important; font-size:17px !important }
.actions .c-1{ background:#1570ef }  /* mavi */
.actions .c-2{ background:#10b981 }  /* yeşil */
.actions .c-3{ background:#f59e0b }  /* amber */
.actions .c-4{ background:#06b6d4 }  /* camgöbeği */
.actions .c-5{ background:#7c3aed }  /* mor */
.actions .c-6{ background:#22c55e }  /* yeşil-2 */
.actions .c-7{ background:#0ea5e9 }  /* açık mavi */
.actions .c-8{ background:#ef4444 }  /* kırmızı */
.actions .c-9{ background:#a855f7 }  /* menekşe */
.actions .c-10{ background:#d946ef } /* fuşya */
</style>
<style>
/* 🔊 Sesi Etkinleştir toast */
#soundUnlockToast{
  position:fixed; z-index:2147483647; right:16px; bottom:16px;
  background:rgba(20,20,20,.92); color:#fff; padding:14px 16px;
  border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.35);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; font-size:14px;
  display:flex; align-items:center; gap:10px;
}
#soundUnlockToast button{
  appearance:none; border:0; border-radius:10px; padding:8px 12px;
  background:#00c853; color:#fff; font-weight:600; cursor:pointer;
}
#soundUnlockToast.hidden{ display:none; }
</style>

<style id="dk-mobile-modal-fix">
/* Modal her zaman en üstte ve sabit (mobil PDA için) */
.modal{ position: fixed !important; inset: 0 !important; z-index: 2147483647 !important; }
.modal .box{ position: absolute !important; top: 50% !important; left: 50% !important; transform: translate(-50%,-50%) !important; max-width: 560px; width: min(92vw,560px); }
</style>

</head>
<body>

<!-- 🔊 Preloaded Audio Files -->
<audio id="sndMatch" src="sounds/match.mp3" preload="auto"></audio>
<audio id="sndCart"  src="sounds/cart.mp3"  preload="auto"></audio>
<audio id="sndFail"  src="sounds/fail.mp3"  preload="auto"></audio>


<!-- 🔊 Preloaded Audio Files -->
<audio id="sndMatch" src="sounds/match.mp3" preload="auto"></audio>
<audio id="sndCart"  src="sounds/cart.mp3"  preload="auto"></audio>
<audio id="sndFail"  src="sounds/fail.mp3"  preload="auto"></audio>

<header>
  <img src="logo.png" alt="Logo" />
  <h1>Fiyat Gör Etiket Bas</h1>
</header>

<div class="wrap">
  <div class="card">
    <div class="control" style="justify-content:space-between">
      <div class="control">
        <span id="badgeData" class="badge"><i class="fa-solid fa-database"></i> Veri yüklenmedi</span>
        <label class="switch" style="display:inline-flex;align-items:center;gap:8px">
          <input id="toggleFx" type="checkbox" checked /> <span>Ses/Titreşim</span>
        </label>
      </div>
      <div class="control">
        <button id="btnCart" class="btn neutral" style="font-size:16px"><i class="fa-solid fa-basket-shopping"></i> Sepet: <span id="cartCount">0</span></button>
        <button id="btnPrint" class="btn success" style="font-size:16px"><i class="fa-solid fa-print"></i> Yazdır</button>
        <button id="btnCam" class="btn primary" style="font-size:16px"><i class="fa-solid fa-camera"></i> Kamera Aç</button>
        <button id="btnCamIOS" class="btn neutral" style="font-size:16px"><i class="fa-brands fa-apple"></i> Kamera Aç (iOS)</button>
      </div>
    </div>

    <div class="control" style="margin-top:8px">
      <button id="btnFull" class="btn neutral"><i class="fa-solid fa-barcode"></i> Barkod ile Arama</button>
<input id="inpFull" class="input" type="text" placeholder="Barkod ile arama (okutun)" autocomplete="off" inputmode="none" enterkeyhint="go"/>
<input id="inpBarcode" class="input" type="tel" placeholder="Barkod SON 6 hane" autocomplete="off" inputmode="numeric" pattern="[0-9]*" enterkeyhint="search"/>
      <input id="inpName" class="input" type="text" placeholder="Ürün adı" autocomplete="off" />
      <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" />
      <button id="btnFetchSheets" class="btn primary"><i class="fa-solid fa-cloud-download"></i> Google Sheets'ten Çek</button>
      <button id="btnFD10" class="btn neutral"><i class="fa-solid fa-clock-rotate-left"></i> Son 10 Günde Değişenler</button>
      <button id="btnSaveCart" class="btn neutral"><i class="fa-solid fa-file-arrow-down"></i> Sepeti Kaydet</button>
      <button id="btnLoadCart" class="btn neutral"><i class="fa-solid fa-file-arrow-up"></i> Sepeti Yükle</button>
      <input id="fileCart" type="file" accept=".json" style="display:none" />
    </div>
    <small class="hint">Excel yükleyin, barkodun son 6 hanesiyle veya ürün adıyla arayın; <b>KAMERA</b> ile okutunca ürün popup'ı direkt açılır.</small>
  </div>
</div>

<!-- Arama sonuçları -->
<div id="mdlSearch" class="modal"><div class="box">
  <h3>Filtrelenen Ürünler</h3>
  <div class="mini">Filtre: <span id="mFilter"></span> — <span id="mCount">0</span> sonuç</div>
  <div id="mList" class="list"></div>
  <div class="actions" style="justify-content:flex-end"><button id="btnSearchClose" class="btn">Kapat</button></div>
</div></div>

<!-- Ürün popup -->
<div id="mdlProduct" class="modal"><div class="box">
  <h3 id="mName">Ürün Adı</h3>
  <div class="price" id="mPrice">₺0,00</div>
  <div class="mini barcodeBig">Barkod: <span id="mBarcode"></span></div>
  <div class="mini" id="mDateRow">Fiyat Değişiklik Tarihi: <span id="mDate"></span></div>
  <div id="mOld" class="warn" style="display:none"><i class="fa-solid fa-triangle-exclamation"></i> Bu ürünün fiyatı <b>12 aydan eski</b>! Yöneticinize bilgi verin.</div>

  <div class="previewLabel" id="previewLabel" style="display:none">
    <img id="previewBarcode" alt="etiket" />
    <div>
      <div class="pname" id="previewName">—</div>
      <div class="mini" id="previewPrice">—</div>
    </div>
  </div>

  <div class="actions">

  <button id="btnQty1" class="btn qty-btn one c-1" data-qty="1">1 Adet</button>
  <button class="btn qty-btn c-2"  data-qty="2">2 Adet</button>
  <button class="btn qty-btn c-3"  data-qty="3">3 Adet</button>
  <button class="btn qty-btn c-4"  data-qty="4">4 Adet</button>
  <button class="btn qty-btn c-5"  data-qty="5">5 Adet</button>
  <button class="btn qty-btn c-6"  data-qty="6">6 Adet</button>
  <button class="btn qty-btn c-7"  data-qty="7">7 Adet</button>
  <button class="btn qty-btn c-8"  data-qty="8">8 Adet</button>
  <button class="btn qty-btn c-9"  data-qty="9">9 Adet</button>
  <button class="btn qty-btn c-10" data-qty="10">10 Adet</button>
  <button class="btn danger" id="btnCancel">İptal</button>
  <button class="btn" id="btnCustom" style="display:none" aria-hidden="true" tabindex="-1">Özel</button>

</div></div>
</div></div>

<!-- Sepet modal -->
<div id="mdlCart" class="modal"><div class="box">
  <h3>Sepet</h3>
  <div class="cartFilters">
    <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="chkOnlyOld"/> Sadece eski fiyatlı</label>
  </div>
  <div id="cartList" class="list"></div>
  <div class="cartTotal mini">Toplam: <span id="cartTotalLbl">0</span> etiket</div>
  <div class="actions" style="justify-content:space-between">
    <button id="btnCartClear" class="btn danger"><i class="fa-solid fa-trash"></i> Hepsini Temizle</button>
    <div>
      <button id="btnCartClose" class="btn">Kapat</button>
      <button id="btnCartPrint" class="btn success"><i class="fa-solid fa-print"></i> Yazdır (PDF)</button>
    </div>
  </div>
</div></div>

<!-- Yazdır öncesi uyarı -->
<div id="mdlOldWarn" class="modal"><div class="box">
  <h3>Eski Fiyat Uyarısı</h3>
  <div class="warn"><i class="fa-solid fa-triangle-exclamation"></i> Listenizde <b>eski fiyatlı</b> ürünler var. Lütfen yöneticinize <b>Eski Fiyatlılar PDF</b>'ini gönderin.</div>
  <div class="confirmRow"><button id="btnOldCancel" class="btn">Vazgeç</button><button id="btnOldContinue" class="btn success">Devam Et</button></div>
</div></div>

<!-- PDF önizleme -->
<div id="mdlPdf" class="modal"><div class="box pdfBox">
  <h3>Önizleme — Etiketler</h3>
  <iframe id="pdfFrame" class="pdfFrame"></iframe>
  <div class="actions" style="justify-content:flex-end"><button id="btnPdfCancel" class="btn">İptal</button><button id="btnPdfSave" class="btn success">Kaydet ve Devam Et</button></div>
</div></div>

<div id="mdlPdfOld" class="modal"><div class="box pdfBox">
  <h3>Önizleme — Eski Fiyatlı Ürünler</h3>
  <iframe id="pdfOldFrame" class="pdfFrame"></iframe>
  <div class="actions" style="justify-content:flex-end">
    <button id="btnPdfOldCancel" class="btn">Kapat</button>
    <button id="btnPdfOldShare" class="btn neutral"><i class="fa-solid fa-share-from-square"></i> Paylaş</button>
    <button id="btnPdfOldSave" class="btn success">Kaydet</button>
  </div>
</div></div>

<div id="toast" class="toast">Veri yüklendi</div>
<div id="work" style="position:fixed;left:-9999px;top:-9999px;opacity:0"></div>

<script>
(function(){
// === LAYOUT CONFIG (27/sayfa) ===
const LABELS_PER_PAGE = { cols: 3, rows: 9, gapPx: 6, pagePaddingPx: 12 }; // 3x9=27
const EDGE_SHIFT_PX = 4; // Sol kolon -4px, sağ kolon +4px

/* ===== STATE ===== */
let PRODUCTS=[];
let CART = JSON.parse(localStorage.getItem('etiket_cart')||'[]');
let FX = JSON.parse(localStorage.getItem('etiket_fx')||'true');
let PRINT_BASE_TS = localStorage.getItem('etiket_print_base_ts');
let TOTAL_PRINTED = parseInt(localStorage.getItem('etiket_total_printed')||'0',10);
if(!PRINT_BASE_TS){ PRINT_BASE_TS = Date.now(); localStorage.setItem('etiket_print_base_ts', PRINT_BASE_TS); }
const IS_DESKTOP = window.matchMedia('(pointer: fine)').matches && !/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
let __docLabels=null, __docOld=null, pendingOldBlobURL=null, pendingLabelsBlobURL=null;

// Kamera kontrol bayrakları
let LAST_CAM_MODE=null;                 // 'android' | 'ios' | null
let CAMERA_WAS_USER_CLOSED=true;        // kullanıcı kapattı mı?
let LAST_OPEN_SOURCE='manual';          // 'scanner' | 'manual'

// YAZDIRMA DURUM BAYRAĞI
let IS_PRINTING=false;

/* ===== EL ===== */
const $=id=>document.getElementById(id);
const inpBarcode=$('inpBarcode'), inpName=$('inpName'), cartCount=$('cartCount'), badgeData=$('badgeData');

/* ===== UTIL ===== */
const fmtTRY=new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:2});
const monthsDiff=(d)=>((new Date())-d)/(1000*60*60*24*30);
const showToast=(msg)=>{const t=$('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500);};

const refocusAfterAction=(clear=false)=>{ if(IS_DESKTOP){ if(clear){ inpBarcode.value=''; inpName.value=''; } inpBarcode.focus(); inpBarcode.select(); } };
const fmtDMY=(d)=>{ try{const dt=(d instanceof Date)?d:new Date(d); if(isNaN(dt))return '—'; const dd=String(dt.getDate()).padStart(2,'0'); const mm=String(dt.getMonth()+1).padStart(2,'0'); const yy=dt.getFullYear(); return `${dd}/${mm}/${yy}`;}catch(_){ return '—'; }};
const fromSci=(str)=>{const m=String(str).toLowerCase().match(/^(\d+(?:\.\d+)?)e\+(\d+)$/);if(!m) return String(str);const d=m[1].replace('.','');const dec=(m[1].split('.')[1]||'').length;const exp=+m[2];return d+'0'.repeat(Math.max(0,exp-dec));};
function parseBarcode(v){ if(v===undefined||v===null)return''; if(typeof v==='number'){const s=String(v);return s.includes('e+')?fromSci(s).replace(/\D/g,''):s.replace(/\D/g,'');} const s=String(v).trim(); if(/e\+\d+$/i.test(s)) return fromSci(s).replace(/\D/g,''); return s.replace(/[^0-9]/g,''); }
function parsePrice(v){ if(v===undefined||v===null||v==='') return 0; if(typeof v==='number') return v; let s=String(v).replace(/[₺\s]/g,'').replace(/\u00A0/g,''); if(s.includes(',') && s.includes('.')){ s = s.replace(/\./g,'').replace(',', '.'); } else if(s.includes(',')){ s = s.replace(',', '.'); } else if(s.includes('.')){ const parts=s.split('.'); const last=parts[parts.length-1]; if(last.length<=2){ s = parts.slice(0,-1).join('') + '.' + last; } else { s = parts.join(''); } } const n=parseFloat(s); return Number.isNaN(n)?0:n; }
function parseExcelDate(v){ if(!v&&v!==0)return null; if(v instanceof Date&&!isNaN(v))return v; if(typeof v==='number'){const epoch=new Date(1899,11,30);return new Date(epoch.getTime()+v*86400000);} const str=String(v).trim(); const m=str.match(/(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/); if(m){const d=new Date(+m[3],+m[2]-1,+m[1],m[4]||0,m[5]||0,m[6]||0); if(!isNaN(d))return d;} if(/^\d{8}$/.test(str)){const y=str.slice(0,4),mo=str.slice(4,6),da=str.slice(6,8); const d=new Date(+y,+mo-1,+da); if(!isNaN(d))return d;} const d=new Date(str); return isNaN(d)?null:d; }
function normKey(s){return String(s||'').toLowerCase().replace(/[ıİ]/g,'i').replace(/[öÖ]/g,'o').replace(/[üÜ]/g,'u').replace(/[ğĞ]/g,'g').replace(/[şŞ]/g,'s').replace(/[çÇ]/g,'c').normalize('NFD').replace(/[̀-ͯ]/g,'').replace(/[^a-z0-9]/g,'');}
function mapRowByKeys(row){ const nk={};Object.keys(row).forEach(k=>nk[normKey(k)]=k);
  const pick=(syns)=>{for(const s of syns){for(const k in nk){if(k===s||k.includes(s))return row[nk[k]];}} return undefined;};
  const barcode=pick(['barkod','barkodno','barkodu','ean','ean13']);
  const name=pick(['stokadi','urunadi','adi','ad','stok','aciklama']);
  const price=pick(['magaza','magazasatis','magazasatisfiyati','magazafiyati','satisfiyati1','satisfiyat1','sf1','fiyat','perakendesatis']);
  const date=pick(['satisfiyati1degtar','satisfiyati1degtarihi','fiyatdegisikliktarihi','fiyatdegtarihi','fdtarihi','degisiktarihi','degistarihi','fiyatguncellemetarihi']);
  return {barcode,name,price,date};
}
function normalizeRow(r){ const m=mapRowByKeys(r); return { barcode:parseBarcode(m.barcode), name:String(m.name||'').trim(), price:parsePrice(m.price), priceDate:parseExcelDate(m.date) }; }


/* ==== DK: FULL Scan Toggle + Mobile Modal Fix ==== */
const btnFull = $('btnFull');
const inpFull = $('inpFull');
let FULL_ACTIVE = false;
let FULL_BUF = "";
let FULL_TID = null;

function __dk_nd(s){ return String(s??'').replace(/\D/g,''); }
function __dk_findStrict(code){
  const arr = PRODUCTS || [];
  const c = __dk_nd(code);
  if(!c) return null;
  let ex = arr.find(p => __dk_nd(p.barcode) === c);
  if(ex) return ex;
  if(c.length===13){
    const c12 = c.slice(1);
    let upc = arr.find(p => { const pb = __dk_nd(p.barcode); return pb.length===12 && pb===c12; });
    if(upc) return upc;
  }else if(c.length===12){
    let ean = arr.find(p => { const pb = __dk_nd(p.barcode); return pb.length===13 && pb.slice(1)===c; });
    if(ean) return ean;
  }
  return null;
}

function __dk_showNF(title, code, msg){
  try{
    $('nfTitle').textContent = title || 'Barkod Bulunamadı';
    $('nfCode').textContent = String(code||'—');
    $('nfMsg').firstChild && ($('nfMsg').firstChild.textContent = msg || 'Okutulan: ');
    try{ inpFull && inpFull.blur(); }catch(_){}
    setTimeout(()=>{ $('mdlNf').classList.add('shown'); }, 10);
    $('btnNfClose').onclick = ()=> $('mdlNf').classList.remove('shown');
  }catch(e){
    alert((title||'Uyarı')+': '+(msg||'')+(code||''));
  }
}

function __dk_submit(val){
/* === DK: FULL → Son-6 pipeline (early delegate) === */
try{
  const __raw = String(arguments[0] ?? val ?? '');
  const __code = parseBarcode(__raw);
  if(Array.isArray(PRODUCTS) && PRODUCTS.length && __code && __code.length>=6){
    // Son-6 arama ile *aynı davranış* için doğrudan filterByLast6
    filterByLast6(__code.slice(-6));
    return;
  }
}catch(__e){ /* no-op */ }

  const raw = String(val||'').replace(/[\r\n]+/g,'');
  const code = parseBarcode(raw);
  FULL_BUF = "";
  if(inpFull){ try{ inpFull.value=''; }catch(_){ } }
  if(!Array.isArray(PRODUCTS) || PRODUCTS.length===0){
    __dk_showNF('Veri Yüklenmedi', code, 'Lütfen Excel yükleyin veya Sheets\'ten çekin. Okutulan: ');
    return;
  }
  if(!code || code.length<8) return;
  const p = __dk_findStrict(code);
  if(p){
    try{ inpFull && inpFull.blur(); }catch(_){}
    // openProduct'ı çağırmadan önce klavyeyi kapat
    openProduct(p,'terminal');
    // kutuyu ortaya kaydır
    try{ $('mdlProduct').querySelector('.box').scrollIntoView({block:'center', inline:'center'}); }catch(_){}
  }else{
    __dk_showNF('Barkod Bulunamadı', code, 'Okutulan: ');
  }
}

function __dk_queueSubmit(){
  if(FULL_TID) clearTimeout(FULL_TID);
  FULL_TID = setTimeout(()=> __dk_submit(FULL_BUF), 120);
}

// Toggle: açıkken global capture aktif, son-6 devreye girmez
if(btnFull){
  btnFull.addEventListener('click', ()=>{
    FULL_ACTIVE = !FULL_ACTIVE;
    FULL_BUF = "";
    try{ btnFull.classList.toggle('primary', FULL_ACTIVE); }catch(_){}
    if(FULL_ACTIVE){
      try{ inpFull && inpFull.focus(); if(inpFull && inpFull.select) inpFull.select(); }catch(_){}
    }
  });
}

// Input-level: Enter/Tab veya newline ile tetikleme
if(inpFull){
  inpFull.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' || e.key==='Tab'){
      e.preventDefault();
      __dk_submit(inpFull.value);
    }
  });
  let _deb;
  inpFull.addEventListener('input', ()=>{
    const v = String(inpFull.value||'');
    if(/\r|\n/.test(v)){
      clearTimeout(_deb);
      _deb = setTimeout(()=> __dk_submit(v), 10);
    }
  });
}

// Global capture (capture phase) — FULL açıkken tüm rakam/Enter son-6'ya düşmez
document.addEventListener('keydown', (e)=>{
  if(!FULL_ACTIVE) return;
  const k = e.key;
  if(/^[0-9]$/.test(k)){
    e.preventDefault(); e.stopPropagation();
    FULL_BUF += k;
    if(inpFull){ try{ inpFull.value = FULL_BUF; }catch(_){ } }
    __dk_queueSubmit();
  }else if(k==='Backspace'){
    e.preventDefault(); e.stopPropagation();
    FULL_BUF = FULL_BUF.slice(0,-1);
    if(inpFull){ try{ inpFull.value = FULL_BUF; }catch(_){ } }
  }else if(k==='Enter' || k==='Tab'){
    e.preventDefault(); e.stopPropagation();
    const v = FULL_BUF;
    __dk_submit(v);
  }else if(k==='Escape'){
    e.preventDefault(); e.stopPropagation();
    FULL_BUF = "";
    if(inpFull){ try{ inpFull.value=''; }catch(_){ } }
  }
}, true);

// openProduct sarmalayıcı — mobil modal güvenliği
(function(){
  const _open = window.openProduct;
  if(typeof _open === 'function'){
    window.openProduct = function(p, source){
      try{ inpFull && inpFull.blur(); }catch(_){}
      const r = _open(p, source||'terminal');
      try{
        // animasyon sonrası ortala
        setTimeout(()=>{
          try{ $('mdlProduct').classList.add('shown'); }catch(_){}
          try{ $('mdlProduct').querySelector('.box').scrollIntoView({block:'center', inline:'center'}); }catch(_){}
        }, 20);
      }catch(_){}
      return r;
    };
  }
})();

/* ===== Sheets & Excel Yükleme ===== */
$('btnFetchSheets').addEventListener('click', ()=>{
  const url='https://docs.google.com/spreadsheets/d/e/2PACX-1vSCE485ORNI2xxxHJkrfJy6IBBeso9hQHxfhZ6dkUShRQWngyeyR5VsZI7rKwBy0A/pub?output=csv';
  fetch(url).then(r=>r.text()).then(csv=>{
    const wb=XLSX.read(csv,{type:'binary'});
    try{
      const sheet=wb.Sheets[wb.SheetNames[0]];
      let rows=XLSX.utils.sheet_to_json(sheet,{defval:'',raw:true,cellDates:true});
      let arr=rows.map(normalizeRow).filter(x=>x.barcode&&x.name);
      PRODUCTS=arr;
      badgeData.innerHTML=`<i class="fa-solid fa-database"></i> ${PRODUCTS.length>0?PRODUCTS.length+' ürün yüklendi (Sheets)':'Hiç ürün okunamadı'}`;
      if(PRODUCTS.length>0) showToast('Veri yüklendi'); else alert('Uygun satır bulunamadı.');
    }catch(err){ alert('Google Sheets verisi okunamadı: '+err); }
  }).catch(err=>alert('Google Sheets’den veri alınamadı: '+err));
});
$('fileExcel').addEventListener('change', (ev)=>{
  const f=ev.target.files[0]; if(!f) return;
  const ext=(f.name.split('.').pop()||'').toLowerCase();
  const loadFromWorkbook=(wb)=>{
    try{
      const sheet=wb.Sheets[wb.SheetNames[0]];
      let rows=XLSX.utils.sheet_to_json(sheet,{defval:'',raw:true,cellDates:true});
      let arr=rows.map(normalizeRow).filter(x=>x.barcode&&x.name);
      if(arr.length<3){
        const A=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
        if(A.length){
          const C=A[0].length,stat=Array.from({length:C},()=>({digits:0,text:0,price:0,date:0}));
          for(let i=1;i<Math.min(A.length,150);i++){
            const r=A[i]||[];
            for(let j=0;j<C;j++){
              const v=r[j]; if(v===undefined||v===null||v==='')continue; const s=String(v);
              if(/^[0-9]{8,14}$/.test(s)||/e\+\d+$/i.test(s))stat[j].digits++;
              if(/[a-zA-ZğüşöçİıĞÜŞÖÇ]/.test(s)&&s.length>3)stat[j].text++;
              if(parsePrice(v)>0)stat[j].price++;
              if(parseExcelDate(v))stat[j].date++;
            }
          }
          const idxMax=k=>stat.map((x,i)=>({i,v:x[k]})).sort((a,b)=>b.v-a.v)[0]?.i??0;
          const ci={barcode:idxMax('digits'),name:idxMax('text'),price:idxMax('price'),date:idxMax('date')};
          for(let i=1;i<A.length;i++){
            const r=A[i]||[];
            const bc=parseBarcode(r[ci.barcode]); const nm=String(r[ci.name]||'').trim();
            const pr=parsePrice(r[ci.price]); const dt=parseExcelDate(r[ci.date]);
            if(bc&&nm)arr.push({barcode:bc,name:nm,price:pr,priceDate:dt});
          }
        }
      }
      PRODUCTS=arr;
      badgeData.innerHTML=`<i class="fa-solid fa-database"></i> ${PRODUCTS.length>0?PRODUCTS.length+' ürün yüklendi (Excel)':'Hiç ürün okunamadı'}`;
      if(PRODUCTS.length>0) showToast('Veri yüklendi'); else alert('Uygun satır bulunamadı.');
    }catch(err){ alert('Excel/CSV okunamadı.'); }
  };
  if(ext==='csv'){ const r=new FileReader(); r.onload=e=>{ const wb=XLSX.read(e.target.result,{type:'binary'}); loadFromWorkbook(wb); }; r.readAsText(f); }
  else{ const r=new FileReader(); r.onload=e=>{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array',cellDates:true}); loadFromWorkbook(wb); }; r.readAsArrayBuffer(f); }
});

/* ===== CART ===== */
function setCart(n){ CART=n; localStorage.setItem('etiket_cart',JSON.stringify(CART)); cartCount.textContent=CART.reduce((a,x)=>a+x.qty,0); }
setCart(CART);

/* ===== SEARCH (manuel) ===== */
function isOld(p){ return p.priceDate ? monthsDiff(new Date(p.priceDate))>12 : false; }
function showResults(title,arr){ $('mFilter').textContent=title; $('mCount').textContent=arr.length; const L=$('mList'); L.innerHTML='';
  arr.slice(0,200).forEach(p=>{ const li=document.createElement('div'); li.className='item';
    li.innerHTML=`<div><div class="nm">${p.name}</div><div class="bc">${p.barcode}</div></div><div>${isOld(p)?'<span class="tag-old">Eski fiyat</span>':''}<span style="font-weight:900;margin-left:8px">${fmtTRY.format(p.price)}</span></div>`;
    li.onclick=()=>{ $('mdlSearch').classList.remove('shown'); openProduct(p,'manual'); }; L.appendChild(li);
  });
  $('mdlSearch').classList.add('shown');
}
function filterByName(q){ const s=q.trim().toLowerCase(); if(s.length<2){ $('mdlSearch').classList.remove('shown'); return; } const res=PRODUCTS.filter(p=>p.name.toLowerCase().includes(s)); if(res.length) showResults(`Ad: "${q}"`,res); else $('mdlSearch').classList.remove('shown'); }
function filterByLast6(v){ const t=v.replace(/\D/g,''); if(t.length<2){ $('mdlSearch').classList.remove('shown'); return; } const res=PRODUCTS.filter(p=>p.barcode.endsWith(t)); if(res.length) showResults(`Barkod son: ${t}`,res); else $('mdlSearch').classList.remove('shown'); }
inpName.addEventListener('input', ()=>{ filterByName(inpName.value); });
inpBarcode.addEventListener('input', ()=>{ filterByLast6(inpBarcode.value); });
;['inpName','inpBarcode'].forEach(id=>$(id).addEventListener('keydown',e=>{ if(e.key==='Enter'){ const first=$('mList')?.firstElementChild; if(first){ first.click(); } }}));
$('btnSearchClose').addEventListener('click', ()=> $('mdlSearch').classList.remove('shown'));

/* ===== PRODUCT POPUP & CART ===== */
// Barkod görseli için önbellek — ağır yükte hızlandırır

// EAN13 validator
function isValidEAN13(code){
  const c = String(code||'').replace(/\D/g,'');
  if (c.length !== 13) return false;
  const d12 = c.slice(0,12).split('').map(Number);
  const sum = d12.reduce((s,d,i)=> s + d * (i%2 ? 3 : 1), 0);
  const chk = (10 - (sum % 10)) % 10;
  return chk === Number(c[12]);
}

// Barkod görseli için önbellek — ağır yükte hızlandırır + EAN13 fallback
const BARCODE_CACHE = new Map();
function getBarcodePng(code){
  const keyRaw = String(code||'').trim();
  if(BARCODE_CACHE.has(keyRaw)) return BARCODE_CACHE.get(keyRaw);

  const key = keyRaw.replace(/\D/g,'');
  const cvs=document.createElement('canvas');

  const wantEAN = (key.length === 13) && isValidEAN13(key);
  const fmt = wantEAN ? 'EAN13' : 'CODE128';

  const opts = {format: fmt,height:48,width:2.2,displayValue:true,font:'Arial',fontSize:16,textMargin:2,margin:0,lineColor:'#000'};

  try{
    JsBarcode(cvs,key,opts);
  }catch(e){
    try{
      JsBarcode(cvs,key,{...opts, format:'CODE128'});
    }catch(e2){
      const ctx = cvs.getContext('2d');
      cvs.width = 180; cvs.height = 60;
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,cvs.width,cvs.height);
      ctx.fillStyle = '#000'; ctx.font='12px Arial';
      ctx.fillText('Barkod render edilemedi', 10, 30);
    }
  }

  const url=cvs.toDataURL('image/jpeg',0.82);
  BARCODE_CACHE.set(keyRaw,url);
  return url;
}

function buildPreview(p){
  try{
    $('previewBarcode').src=getBarcodePng(p.barcode);
    $('previewName').textContent=p.name; $('previewPrice').textContent=fmtTRY.format(p.price);
    $('previewLabel').style.display='flex';
  }catch(_){ $('previewLabel').style.display='none'; }
}

const mdl=$('mdlProduct');
window.openProduct=function(p, source='manual'){
  LAST_OPEN_SOURCE = source || 'manual';
  $('mName').textContent=p.name; $('mPrice').textContent=fmtTRY.format(p.price); $('mBarcode').textContent=p.barcode;
  const d=p.priceDate? new Date(p.priceDate):null; $('mDate').textContent=d?fmtDMY(d):'—'; $('mDateRow').style.display=d?'block':'none';
  const old=isOld(p); $('mOld').style.display=old?'block':'none';
  buildPreview(p);

  try{ window.__lastProduct=p; window.__lastIsOld=old; if (typeof playSound==="function") playSound("sndCart"); }catch(e){} mdl.classList.add('shown');
  mdl.querySelectorAll('[data-qty]').forEach(b=> b.onclick=()=> addToCart(p,parseInt(b.dataset.qty),old));
  $('btnCustom').onclick=()=>{ const q=parseInt(askAdet); if(q>0) addToCart(p,q,old); };
  $('btnCancel').onclick=()=>{ mdl.classList.remove('shown'); refocusAfterAction(true); };
}

function reopenCamAfterAction(){
  // Sadece scanner akışından gelen popupta ve kullanıcı kapatmamışsa yeniden aç
  if(LAST_OPEN_SOURCE!=='scanner') return;
  if(CAMERA_WAS_USER_CLOSED) return;
  if(LAST_CAM_MODE==='android'){ if(window.__startCamera) setTimeout(()=>window.__startCamera(true), 120); }
  else if(LAST_CAM_MODE==='ios'){ if(window.__startIOS) setTimeout(()=>window.__startIOS(true), 120); }
}

function addToCart(p,qty,isOldFlag){
  if(qty>=10 && !confirm('⚠️ Bu üründen 10 adet seçtiniz, emin misiniz?')) return;
  const idx=CART.findIndex(x=>x.barcode===p.barcode);
  if(idx>-1) CART[idx].qty+=qty; else CART.push({barcode:p.barcode,name:p.name,price:p.price,isOld:!!isOldFlag,qty});
  setCart(CART);
  mdl.classList.remove('shown'); beep(true); refocusAfterAction(true);
  reopenCamAfterAction(); // yalnızca scanner akışında ve kullanıcı kapatmadıysa
}

/* ===== CART MODAL ===== */
function renderCart(){
  const onlyOld=$('chkOnlyOld').checked;
  const list=onlyOld?CART.filter(x=>x.isOld):CART;
  const L=$('cartList'); L.innerHTML='';
  list.forEach((it,idx)=>{ const row=document.createElement('div'); row.className='cartRow';
    row.innerHTML=`<div><div class="cartName">${it.name}</div><div class="mini">${it.barcode} • ${fmtTRY.format(it.price)} ${it.isOld?'<span class="tag-old" style="margin-left:6px">Eski</span>':''}</div></div><div class="qtyCtrl" data-idx="${idx}"><button class="dec">−</button><span>${it.qty}</span><button class="inc">+</button><button class="del" title="Sil"><i class="fa-solid fa-trash"></i></button></div>`;
    L.appendChild(row);
  });
  $('cartTotalLbl').textContent=CART.reduce((a,x)=>a+x.qty,0);
}
$('btnCart').addEventListener('click', ()=>{ renderCart(); $('mdlCart').classList.add('shown'); });
$('btnCartClose').addEventListener('click', ()=> $('mdlCart').classList.remove('shown'));
$('btnCartClear').addEventListener('click', ()=>{ if(confirm('Sepeti tamamen temizle?')){ setCart([]); renderCart(); } });
$('btnCartPrint').addEventListener('click', ()=>{ $('mdlCart').classList.remove('shown'); $('btnPrint').click(); });
$('cartList').addEventListener('click', (e)=>{
  const ctr=e.target.closest('.qtyCtrl'); if(!ctr)return;
  const idx=+ctr.dataset.idx; const onlyOld=$('chkOnlyOld').checked;
  const list=onlyOld?CART.filter(x=>x.isOld):CART; const item=list[idx];
  const realIdx=CART.findIndex(x=>x.barcode===item.barcode);
  if(e.target.classList.contains('inc')) CART[realIdx].qty++;
  else if(e.target.classList.contains('dec')) CART[realIdx].qty=Math.max(1,CART[realIdx].qty-1);
  else if(e.target.classList.contains('del')) CART.splice(realIdx,1);
  setCart(CART); renderCart();
});
$('chkOnlyOld').addEventListener('change', renderCart);

/* ===== FX SWITCH ===== */
$('toggleFx').checked=!!FX; $('toggleFx').addEventListener('change', ()=>{ FX=$('toggleFx').checked; localStorage.setItem('etiket_fx',JSON.stringify(FX)); });

/* ===== LABEL RENDERER (UI preview) ===== */
function buildLabelNode(it){
  const barPng=getBarcodePng(it.barcode);
  const priceStr=fmtTRY.format(it.price).replace('₺','');
  const wrap=document.createElement('div');
  wrap.className='etiket';
  const isOld = !!it.isOld;
  wrap.innerHTML=`<div class="etiket-logo"><img src="logo.png" alt="Logo" crossorigin="anonymous"></div>
    <div class="etiket-icerik">
      <div class="etiket-stokadi">${it.name}</div>
      <div class="etiket-row">
        <div class="etiket-fiyat-wrap">
          <div class="etiket-fiyat-etiket">Satış Fiyatı <span class="old-ico" style="display:${isOld?'inline-flex':'none'}">🎯</span></div>
          <div class="etiket-fiyat">${priceStr} <span class="tlsimge">₺</span></div>
        </div>
        <div class="etiket-barkod"><img src="${barPng}" alt="Barkod"></div>
      </div>
    </div>`;

  try{
    const nameEl = wrap.querySelector('.etiket-stokadi');
    if(nameEl){
      const L = (it.name||'').length;
      let fs = 13;
      if(L <= 10) fs = 14; else if(L >= 28) fs = 11; else if(L >= 20) fs = 12;
      nameEl.style.fontSize = fs + 'px';
    }
  }catch(_){}
  try{
    const priceEl = wrap.querySelector('.etiket-fiyat');
    if(priceEl){
      const raw = (it.price!=null?Number(it.price):0);
      const abs = Math.floor(Math.abs(raw));
      const digits = String(abs).length;
      let fs = 26;
      if(digits <= 1) fs = 28;
      else if(digits == 2) fs = 26;
      else if(digits == 3) fs = 24;
      else fs = 26;
      priceEl.style.fontSize = fs + 'px';
      const minFs = 22;
      let guard = 0;
      while(guard++ < 8 && priceEl.scrollWidth > priceEl.clientWidth && fs > minFs){
        fs -= 1; priceEl.style.fontSize = fs + 'px';
      }
    }
  }catch(_){}
  return wrap;
}

/* ===== PRINT: Önizleme + Kaydet + Eski Liste ===== */
function hasOldInCart(){ return CART.some(x=>x.isOld); }

$('btnPrint').addEventListener('click', async ()=>{
  if(IS_PRINTING) return;
  if(CART.length===0){ alert('Sepet boş.'); return; }
  if(hasOldInCart()){
    $('mdlOldWarn').classList.add('shown');
  }else{
    await makeAndShowLabelsPreview();
  }
});
// disabled old warn
// disabled old warn continue

async function makeAndShowLabelsPreview(){
  try{
    IS_PRINTING=true; const btn=$('btnPrint'); if(btn) btn.disabled=true;
    __docLabels = await makeLabelsDoc();
    const blob = __docLabels.output('blob');
    if(pendingLabelsBlobURL) URL.revokeObjectURL(pendingLabelsBlobURL);
    pendingLabelsBlobURL = URL.createObjectURL(blob);
    $('pdfFrame').src = pendingLabelsBlobURL; $('mdlPdf').classList.add('shown');
  } finally {
    IS_PRINTING=false; const btn=$('btnPrint'); if(btn) btn.disabled=false;
  }
}

$('btnPdfCancel').addEventListener('click', ()=> {
  $('mdlPdf').classList.remove('shown');
  try{ if(pendingLabelsBlobURL){ URL.revokeObjectURL(pendingLabelsBlobURL); pendingLabelsBlobURL=null; } }catch(_){}
});
$('btnPdfSave').addEventListener('click', async ()=>{
  const totalNow = CART.reduce((a,x)=>a+x.qty,0);
  TOTAL_PRINTED += totalNow;
  localStorage.setItem('etiket_total_printed', TOTAL_PRINTED);

  __docLabels.save(`etiketler_${new Date().toISOString().slice(0,10)}.pdf`);
  $('mdlPdf').classList.remove('shown');

  __docOld = await makeOldListDoc();
  const blobOld = __docOld.output('blob');
  if(pendingOldBlobURL) URL.revokeObjectURL(pendingOldBlobURL);
  pendingOldBlobURL = URL.createObjectURL(blobOld);
  $('pdfOldFrame').src = pendingOldBlobURL;
  $('mdlPdfOld').classList.add('shown');
});

$('btnPdfOldCancel').addEventListener('click', ()=> {
  $('mdlPdfOld').classList.remove('shown');
  try{ if(pendingOldBlobURL){ URL.revokeObjectURL(pendingOldBlobURL); pendingOldBlobURL=null; } }catch(_){}
});
$('btnPdfOldSave').addEventListener('click', ()=>{
  __docOld.save(`eski_fiyatli_${new Date().toISOString().slice(0,10)}.pdf`);
  const log = JSON.parse(localStorage.getItem('etiket_log')||'[]');
  const oldCount = CART.reduce((a,x)=>a+(x.isOld?x.qty:0),0);
  log.push({ts:Date.now(), oldCount});
  localStorage.setItem('etiket_log', JSON.stringify(log));
  alert('Eski Fiyatlı ürünler PDF’i oluşturuldu. LÜTFEN YÖNETİCİNİZE GÖNDERİN.');
});

$('btnPdfOldShare').addEventListener('click', async ()=>{
  try{
    const res = await fetch(pendingOldBlobURL); const blob = await res.blob();
    const file = new File([blob], `eski_fiyatli_${new Date().toISOString().slice(0,10)}.pdf`, {type:'application/pdf'});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({ files:[file], title:'Eski Fiyatlı Ürünler', text:'Lütfen yöneticinize gönderin.' });
    }else{
      const a=document.createElement('a'); a.href=pendingOldBlobURL; a.download=file.name; a.click();
    }
  }catch(e){ alert('Paylaşım mümkün değil. Dosya indirilecek.'); const a=document.createElement('a'); a.href=pendingOldBlobURL; a.download='eski_fiyatli.pdf'; a.click(); }
});

async function makeLabelsDoc(){
  const { jsPDF }=window.jspdf;
  const A4W=210, A4H=297, margin=5;

  const labels=[]; CART.forEach(it=>{ for(let i=0;i<it.qty;i++) labels.push(it); });
  const per = (LABELS_PER_PAGE.cols * LABELS_PER_PAGE.rows); // 27/sayfa
  const pages = Math.max(1, Math.ceil(labels.length / per));
  const doc = new jsPDF({unit:'mm',format:'a4'});

  const work = document.getElementById('work') || (()=>{const d=document.createElement('div'); d.id='work'; d.style.cssText='position:fixed;left:-9999px;top:-9999px;opacity:0'; document.body.appendChild(d); return d;})();
  work.innerHTML='';

  // Dinamik çözünürlük: çok sayfa varsa belleği koru
  const SCALE = 6; // >2 sayfa ise 4, aksi halde 6

  for(let p=0; p<pages; p++){
    if(p>0) doc.addPage();
    const slice = labels.slice(p*per, p*per + per);
    while(slice.length < per) slice.push(null);

    const pageNode = await renderPageWithOriginalDOM(doc, slice);
    work.appendChild(pageNode);

    const canvas = await html2canvas(pageNode,{scale:SCALE,useCORS:true,allowTaint:true,background:'#fff', logging:false});
    const img = canvas.toDataURL('image/jpeg',0.92);
    doc.addImage(img,'JPEG',margin,margin,A4W-margin*2,A4H-margin*2);

    // Bellek temizliği — sayfa DOM'unu hemen kaldır
    try{ work.removeChild(pageNode); }catch(_){}

    if(p===pages-1){
      const total = CART.reduce((a,x)=>a+x.qty,0);
      const oldCount = CART.reduce((a,x)=>a+(x.isOld?x.qty:0),0);
      const sinceTxt = `${new Date(+PRINT_BASE_TS).toLocaleString('tr-TR')}’den beri ${TOTAL_PRINTED+total} etiket basıldı.`;
      doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(17,24,39);
      doc.text(`Toplam: ${total} • Eski fiyatlı: ${oldCount} • ${sinceTxt}`, A4W/2, A4H-3, {align:'center'});
    } else {
      doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(100,116,139);
      doc.text('Devamı sonraki sayfada…', A4W-10, A4H-3, {align:'right'});
    }
  }

  // Son temizleme
  try{ work.innerHTML=''; }catch(_){}
  return doc;
}

async function renderPageWithOriginalDOM(doc, labelsSlice){
  const pagePxW = 794;   // ~ A4 @96dpi (html2canvas ön yüz)
  const pagePxH = 1123;
  const pad = LABELS_PER_PAGE.pagePaddingPx;
  const gap = LABELS_PER_PAGE.gapPx;
  const cols = LABELS_PER_PAGE.cols;
  const rows = LABELS_PER_PAGE.rows;
  const cellW = Math.floor((pagePxW - pad*2 - gap*(cols-1)) / cols);
  const cellH = Math.floor((pagePxH - pad*2 - gap*(rows-1)) / rows);

  const page = document.createElement('div');
  page.style.cssText = `width:${pagePxW}px;height:${pagePxH}px;display:grid;grid-template-columns:repeat(${cols},${cellW}px);grid-auto-rows:${cellH}px;gap:${gap}px;padding:${pad}px;background:#fff;`;

  // Column-major placement: left column fills top-to-bottom, then middle, then right.
  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      const idx = c*rows + r; // column-major index into labelsSlice
      const it = labelsSlice[idx] || null;

      const cell = document.createElement('div');
      cell.style.cssText = "position:relative;overflow:visible;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:6px;";

      if(it){
        let node = buildLabelNode(it);

        // measure natural size once to get accurate scale inside cell
        const off = document.createElement('div');
        off.style.cssText="position:absolute;left:-10000px;top:-10000px;opacity:0;";
        off.appendChild(node);
        document.body.appendChild(off);
        const rect = node.getBoundingClientRect();
        const naturalW = Math.max(1, rect.width);
        const naturalH = Math.max(1, rect.height);
        document.body.removeChild(off);

        const scale = Math.min(cellW / naturalW, cellH / naturalH);

        const scaler = document.createElement('div');
        scaler.style.cssText = `width:${Math.round(naturalW*scale)}px;height:${Math.round(naturalH*scale)}px;transform-origin:top left;`;
        node.style.transformOrigin = "top left";
        node.style.transform = `scale(${scale})`;
        scaler.appendChild(node);

        const holder = document.createElement('div');
        holder.style.cssText = "position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;";
        holder.appendChild(scaler);

        // Edge column micro-shift
        if(c===0){ holder.style.transform = `translateX(-${EDGE_SHIFT_PX}px)`; }
        else if(c===2){ holder.style.transform = `translateX(${EDGE_SHIFT_PX}px)`; }

        cell.appendChild(holder);
      }
      // Even if empty, append the cell to keep grid structure
      page.appendChild(cell);
    }
  }
  return page;
}

async function makeOldListDoc(){
  const old=CART.filter(x=>x.isOld);
  const { jsPDF }=window.jspdf; const doc=new jsPDF({unit:'mm',format:'a4'});

  doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('Eski Fiyatlı Ürünler', 10, 12);
  doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR')}  •  Toplam: ${old.reduce((a,x)=>a+x.qty,0)} etiket`, 10, 18);

  let y=26; old.forEach(it=>{
    const png=getBarcodePng(it.barcode);
    doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text(it.name, 10, y); y+=4;
    doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(`${it.barcode}  •  FD: ${fmtDMY(it.priceDate)}  •  ${fmtTRY.format(it.price)}`, 10, y);
    doc.addImage(png,'PNG', 150, y-8, 45, 12); y+=10;
    if(y>285){ doc.addPage(); y=20; }
  });
  return doc;
}

/* ===== Sepeti Kaydet + Yükle + QR ===== */
function downloadJSON(name,data){ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),5000); }
$('btnSaveCart').addEventListener('click', async ()=>{
  if(CART.length===0){ alert('Sepet boş.'); return; }
  if(confirm('QR kod oluşturup paylaşmak ister misiniz?')){
    const modal=document.createElement('div'); modal.className='modal shown'; modal.innerHTML=`<div class="box"><h3>Sepeti Paylaş (QR)</h3><div id="qrWrap" style="display:flex;justify-content:center;padding:10px"></div><div class="actions" style="justify-content:flex-end"><button class="btn" id="qrClose">Kapat</button><button class="btn neutral" id="qrShare"><i class="fa-solid fa-share"></i> Paylaş</button></div></div>`; document.body.appendChild(modal);
    const dataStr=JSON.stringify(CART);
    const qrDiv=modal.querySelector('#qrWrap'); new QRCode(qrDiv,{text:dataStr,width:180,height:180});
    modal.querySelector('#qrClose').onclick=()=>{ modal.remove(); };
    modal.querySelector('#qrShare').onclick=async()=>{
      try{ const blob=new Blob([dataStr],{type:'application/json'}); const file=new File([blob],'sepet.json',{type:'application/json'}); if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file],title:'Sepet',text:'Etiket sepeti'}); } else { downloadJSON('sepet.json', CART); } }catch(_){ downloadJSON('sepet.json', CART); }
    };
  }else{
    downloadJSON('sepet.json', CART);
  }
});

// JSON Yükleme (import)
$('btnLoadCart').addEventListener('click', ()=> $('fileCart').click());
$('fileCart').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    if(!Array.isArray(data)) throw new Error('Geçersiz sepet dosyası');
    // Basit normalizasyon + birleştirme
    const merge = confirm('Yüklenen sepet mevcut sepetin ÜSTÜNE EKLENSİN mi? (İptal: Eski sepet silinir)');
    const map = new Map();
    const push = (it)=>{
      const key = String(it.barcode||'').trim();
      if(!key) return;
      const prev = map.get(key) || {barcode:key, name:String(it.name||''), price:Number(it.price||0), isOld:!!it.isOld, qty:0};
      prev.qty += Math.max(1, Number(it.qty||1));
      // isOld OR mantığı
      prev.isOld = !!(prev.isOld || it.isOld);
      // name/price boşsa mevcut değerlerden doldur
      if(!prev.name && it.name) prev.name = String(it.name);
      if(!prev.price && it.price) prev.price = Number(it.price);
      map.set(key, prev);
    };
    if(merge){ (CART||[]).forEach(push); }
    (data||[]).forEach(push);
    const next = Array.from(map.values());
    setCart(next);
    renderCart();
    showToast('Sepet yüklendi');
  }catch(e){
    alert('Sepet yüklenemedi: ' + (e?.message||e));
  }finally{
    ev.target.value = '';
  }
});

// Otomatik JSON kaydı (mevcut davranış korunur)
window.addEventListener('beforeunload', (e)=>{
  if(CART.length>0){
    try{ downloadJSON('sepet.json', CART); }catch(_){}
  }
});

/* ===== FD Son 10 Gün ===== */
$('btnFD10').addEventListener('click', ()=>{
  const now=Date.now();
  const ten=10*86400000;
  const recent=PRODUCTS.filter(p=> p.priceDate && (now - new Date(p.priceDate).getTime()) <= ten);
  const map=new Map();
  for(const p of recent){ const key=p.name+'__'+p.price; if(!map.has(key)) map.set(key, []); map.get(key).push(p); }
  const L=document.createElement('div'); L.className='list';
  for(const [key,arr] of map){
    const [nm,price]=key.split('__'); const card=document.createElement('div'); card.className='groupCard'; card.innerHTML=`<div class="ttl">${nm}${arr.length>1?' <span class="mini">(VE RENKLERİ)</span>':''}</div><div class="mini">${fmtTRY.format(+price)} • ${arr.length} barkod</div><div class="variants"></div>`; const v=card.querySelector('.variants');
    arr.forEach(p=>{ const chip=document.createElement('div'); chip.className='variant'; chip.textContent=p.barcode; chip.title=p.barcode; chip.onclick=()=> openProduct(p,'manual'); v.appendChild(chip); });
    L.appendChild(card);
  }
  const md=document.createElement('div'); md.className='modal shown'; md.innerHTML=`<div class="box"><h3>Son 10 Günde Fiyatı Değişenler</h3><div class="mini">Toplam grup: ${map.size}</div></div>`; md.querySelector('.box').appendChild(L); const row=document.createElement('div'); row.className='actions'; row.style.justifyContent='flex-end'; row.innerHTML='<button class="btn" id="fd10Close">Kapat</button>'; md.querySelector('.box').appendChild(row); document.body.appendChild(md); md.querySelector('#fd10Close').onclick=()=>md.remove();
});

/* ===== Kamera — Android ===== */
(function(){
  let stream=null, scanning=false, starting=false, rafId=null, bdDetector=null;
  const SHEET_ID='camSheet';
  const sheetEl=document.createElement('div'); sheetEl.id=SHEET_ID; sheetEl.innerHTML='<div id="camBox"><div id="camHead"><b>Kamera</b><div><button id="camClose" class="btn">Kapat</button></div></div><div id="camMount"><video id="camVideo" autoplay playsinline muted></video></div><div id="camFoot"><button id="camStop" class="btn">Durdur</button></div></div>'; document.body.appendChild(sheetEl);
  const camSheet=sheetEl, camMount=document.getElementById('camMount'); const camCloseBtn=document.getElementById('camClose'); const camStopBtn=document.getElementById('camStop');
  camCloseBtn.addEventListener('click', ()=>{ closeCam(true); }); camStopBtn.addEventListener('click', ()=>{ closeCam(true); });
  const getVideo=()=>document.getElementById('camVideo');
  function replaceVideo(){ const old=getVideo(); const v=document.createElement('video'); v.id='camVideo'; v.autoplay=true; v.playsInline=true; v.muted=true; if(old&&old.parentNode) old.parentNode.replaceChild(v,old); else camMount.appendChild(v); return v; }
  async function pickRearDeviceId(){ try{ const devices=await navigator.mediaDevices.enumerateDevices(); const cams=devices.filter(d=>d.kind==='videoinput'); if(!cams.length) return null; let rear=cams.find(d=>/back|rear|environment/i.test(d.label)); return (rear||cams[cams.length-1]).deviceId; }catch(_){ return null; } }
  async function tryGetStream(){ const rearId=await pickRearDeviceId(); const constraints = rearId?{video:{deviceId:{exact:rearId}, width:{ideal:1920}, height:{ideal:1080}, facingMode:{ideal:'environment'}}}:{video:{facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080}}}; return await navigator.mediaDevices.getUserMedia(constraints); }
  async function waitForPlaying(video,timeout=1500){ if(video.readyState>=2) return; await new Promise((res)=>{ let done=false; const ok=()=>{ if(done) return; done=true; cleanup(); res(); }; const tid=setTimeout(ok,timeout); const cleanup=()=>{ video.removeEventListener('loadeddata',ok); clearTimeout(tid); }; video.addEventListener('loadeddata',ok); }); }
  function setBtnBusy(b){ const cam=$('btnCam'); if(cam) cam.disabled=b; }
  async function startCamera(manual=false){
    if(manual===true){ LAST_CAM_MODE='android'; CAMERA_WAS_USER_CLOSED=false; }
    if(starting||scanning) return; starting=true; setBtnBusy(true); camSheet.style.display='block'; stopCamera(false);
    let v=replaceVideo();
    try{
      stream=await tryGetStream();
      v.srcObject=stream; await v.play().catch(()=>{}); await waitForPlaying(v,1500);
    }catch(err){ starting=false; setBtnBusy(false); alert('Kamera başlatılamadı: '+(err?.message||err)); camSheet.style.display='none'; return; }
    let canBD='BarcodeDetector' in window;
    if(canBD){
      try{ const supported=await BarcodeDetector.getSupportedFormats(); const wanted=['ean-13','upc-a']; const fmts=supported.filter(f=>wanted.includes(f)); bdDetector=new BarcodeDetector({formats: fmts.length?fmts:undefined}); }catch(_){ canBD=false; }
    }
    scanning=true; starting=false; setBtnBusy(false);
    const tick=async()=>{
      if(!scanning) return;
      try{ const v=getVideo(); const codes=await bdDetector.detect(v); if(codes && codes.length){ let raw=(codes[0].rawValue??codes[0].value??'').toString(); let m=raw.match(/\d{8,}/g); const code=m?m.sort((a,b)=>b.length-a.length)[0]:raw; onDetected(code); return; } }catch(_e){}
      rafId=requestAnimationFrame(tick);
    };
    if(canBD) rafId=requestAnimationFrame(tick);
  }
  function onDetected(code){
    if(!code) return; const c=String(code).replace(/\D/g,'');
    if(c.length<8) return;
    stopCamera(false); camSheet.style.display='none';
    const p=findProduct(c); if(p){ openProduct(p,'scanner'); } else { const inp=$('inpBarcode'); if(inp){ inp.value=c.slice(-6); inp.dispatchEvent(new Event('input',{bubbles:true})); } }
    try{ if(navigator.vibrate) navigator.vibrate(35); }catch(_){}
  }
  function findProduct(code){
    const arr=PRODUCTS||[]; const norm=s=>String(s??'').replace(/\D/g,'');
    const c=norm(code);
    let exact=arr.find(p=>norm(p.barcode)===c); if(exact) return exact;
    if(c.length===13){ const c12=c.slice(1); const upc=arr.find(p=>norm(p.barcode).length===12 && norm(p.barcode)===c12); if(upc) return upc; }
    if(c.length===12){ const ean=arr.find(p=>norm(p.barcode).length===13 && norm(p.barcode).slice(1)===c); if(ean) return ean; }
    const suf=arr.find(p=>{const pb=norm(p.barcode); return pb.length>=8 && c.length>=8 && (pb.endsWith(c)||c.endsWith(pb));});
    return suf||null;
  }
  function stopCamera(user=false){
    try{ scanning=false; starting=false; if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }catch(_){}
    try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(_){}
    try{ const v=getVideo(); if(v) v.srcObject=null; }catch(_){}
    if(user===true){ CAMERA_WAS_USER_CLOSED=true; LAST_CAM_MODE=null; }
  }
  function closeCam(user=true){ stopCamera(user); camSheet.style.display='none'; setBtnBusy(false); }
  $('btnCam').addEventListener('click', ()=> startCamera(true));
  // Popup sonrası otomatik açma çağrısı
  window.__startCamera = (force)=>{ if(force && LAST_CAM_MODE==='android' && CAMERA_WAS_USER_CLOSED===false){ startCamera(false); } };
})();

/* ===== Kamera — iOS ===== */
(function(){
  let scanning=false, starting=false, rafId=null, stream=null, bdDetector=null;
  const SHEET_ID='camSheetIOS';
  const sheetEl=document.createElement('div'); sheetEl.id=SHEET_ID; sheetEl.innerHTML='<div id="camBoxIOS"><div id="camHeadIOS"><b>Kamera (iOS)</b><div><button id="camCloseIOS" class="btn">Kapat</button></div></div><div id="camMountIOS"><video id="camVideoIOS" autoplay playsinline muted></video></div><div id="camFootIOS"><button id="camStopIOS" class="btn">Durdur</button></div></div>'; document.body.appendChild(sheetEl);
  const camSheet=sheetEl; const camMount=document.getElementById('camMountIOS');
  const getVideo=()=>document.getElementById('camVideoIOS');
  function replaceVideo(){ const old=getVideo(); const v=document.createElement('video'); v.id='camVideoIOS'; v.autoplay=true; v.playsInline=true; v.muted=true; if(old&&old.parentNode) old.parentNode.replaceChild(v,old); else camMount.appendChild(v); return v; }
  async function pickRearDeviceId(){ try{ const devices=await navigator.mediaDevices.enumerateDevices(); const cams=devices.filter(d=>d.kind==='videoinput'); if(!cams.length) return null; let rear=cams.find(d=>/back|rear|environment/i.test(d.label)); return (rear||cams[cams.length-1]).deviceId; }catch(_){ return null; } }
  async function getStream(){ const rear=await pickRearDeviceId(); const constraints = rear?{video:{deviceId:{exact:rear}, width:{ideal:1920}, height:{ideal:1080}, facingMode:{ideal:'environment'}}}:{video:{facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080}}}; return navigator.mediaDevices.getUserMedia(constraints); }
  async function waitForPlaying(video,timeout=1500){ if(video.readyState>=2) return; await new Promise((res)=>{ let done=false; const ok=()=>{ if(done) return; done=true; cleanup(); res(); }; const tid=setTimeout(ok,timeout); const cleanup=()=>{ video.removeEventListener('loadeddata',ok); clearTimeout(tid); }; video.addEventListener('loadeddata',ok); }); }
  async function startIOS(manual=false){
    if(manual===true){ LAST_CAM_MODE='ios'; CAMERA_WAS_USER_CLOSED=false; }
    if(starting||scanning) return; starting=true; camSheet.style.display='block'; stopCamera(false); const v=replaceVideo();
    try{ stream=await getStream(); v.srcObject=stream; await v.play().catch(()=>{}); await waitForPlaying(v,1500); }catch(err){ starting=false; camSheet.style.display='none'; alert('Kamera açılamadı (iOS): '+(err?.message||err)); return; }
    let canBD='BarcodeDetector' in window;
    if(canBD){ try{ const fmts=await BarcodeDetector.getSupportedFormats(); const use=fmts.filter(f=>['ean-13','upc-a'].includes(f)); bdDetector=new BarcodeDetector({formats: use.length?use:undefined}); }catch(_){ canBD=false; } }
    scanning=true; starting=false;
    const off=document.createElement('canvas'); const offctx=off.getContext('2d',{ willReadFrequently:true });
    const tick=async()=>{
      if(!scanning) return;
      try{ const v=getVideo(); let w=v.videoWidth||640,h=v.videoHeight||480; if(w>0&&h>0){ off.width=w; off.height=h; offctx.drawImage(v,0,0,w,h); if(bdDetector){ const codes=await bdDetector.detect(off); if(codes&&codes.length){ let raw=(codes[0].rawValue??codes[0].value??'').toString(); let m=raw.match(/\d{8,}/g); const code=m?m.sort((a,b)=>b.length-a.length)[0]:raw; onDetected(code); return; } } } }catch(_){ }
      rafId=requestAnimationFrame(tick);
    }; rafId=requestAnimationFrame(tick);
  }
  function onDetected(code){
    if(!code) return; const c=String(code).replace(/\D/g,'');
    if(c.length<8) return;
    stopCamera(false); camSheet.style.display='none';
    const p=findProduct(c); if(p){ openProduct(p,'scanner'); } else { const inp=$('inpBarcode'); if(inp){ inp.value=c.slice(-6); inp.dispatchEvent(new Event('input',{bubbles:true})); } }
    try{ if(navigator.vibrate) navigator.vibrate(35); }catch(_){}
  }
  function findProduct(code){
    const arr=PRODUCTS||[]; const norm=s=>String(s??'').replace(/\D/g,'');
    const c=norm(code);
    let exact=arr.find(p=>norm(p.barcode)===c); if(exact) return exact;
    if(c.length===13){ const c12=c.slice(1); const upc=arr.find(p=>norm(p.barcode).length===12 && norm(p.barcode)===c12); if(upc) return upc; }
    if(c.length===12){ const ean=arr.find(p=>norm(p.barcode).length===13 && norm(p.barcode).slice(1)===c); if(ean) return ean; }
    const suf=arr.find(p=>{const pb=norm(p.barcode); return pb.length>=8 && c.length>=8 && (pb.endsWith(c)||c.endsWith(pb));});
    return suf||null;
  }
  function stopCamera(user=false){
    try{ scanning=false; starting=false; if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }catch(_){}
    try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(_){}
    try{ const v=getVideo(); if(v) v.srcObject=null; }catch(_){}
    if(user===true){ CAMERA_WAS_USER_CLOSED=true; LAST_CAM_MODE=null; }
  }
  function closeIOS(user=true){ stopCamera(user); camSheet.style.display='none'; }
  document.getElementById('camCloseIOS').addEventListener('click', ()=> closeIOS(true));
  document.getElementById('camStopIOS').addEventListener('click', ()=> closeIOS(true));
  document.getElementById('btnCamIOS').addEventListener('click', ()=> startIOS(true));
  window.__startIOS = (force)=>{ if(force && LAST_CAM_MODE==='ios' && CAMERA_WAS_USER_CLOSED===false){ startIOS(false); } };
})();


// === DIRECT PRINT (no preview) ===
async function directPrint(){
  if(IS_PRINTING) return;
  if(CART.length===0){ alert('Sepet boş.'); return; }
  try{
    IS_PRINTING=true; const b1=$('btnPrint'); const b2=$('btnCartPrint'); if(b1) b1.disabled=true; if(b2) b2.disabled=true;

    // create labels pdf
    const doc = await makeLabelsDoc();
    const stamp = (function(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,'0');
      return d.getFullYear().toString()+pad(d.getMonth()+1)+pad(d.getDate())+'_'+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds())+'_'+String(d.getMilliseconds()).padStart(3,'0')+'_'+Math.floor(Math.random()*1000);
    })();
    const fname = 'etiketler_'+stamp+'.pdf';
    doc.save(fname);

    // if old items exist, auto-generate & save the "old prices" PDF too
    if(hasOldInCart()){
      try{
        const oldDoc = await makeOldListDoc();
        oldDoc.save('eski_fiyatli_'+stamp+'.pdf');
        // info alert as requested in model context
        setTimeout(()=>{
          alert("Fiyat değişiklik tarihi eski olan ürünlerin PDF’si oluşturuldu. LÜTFEN GRUBA GÖNDERİN.");
        }, 300);
      }catch(_){ /* fail silently */ }
    }
  }catch(e){
    alert('Yazdırma sırasında hata: '+ (e?.message||e));
  }finally{
    IS_PRINTING=false; const b1=$('btnPrint'); const b2=$('btnCartPrint'); if(b1) b1.disabled=false; if(b2) b2.disabled=false;
  }
}


$('btnPrint').onclick = directPrint;
$('btnCartPrint').onclick = ()=>{ $('mdlCart').classList.remove('shown'); directPrint(); };

})(); // IIFE end
</script>

<!-- Audio Unlock + Strong Beep/Haptic Helpers (non-breaking) -->
<script>
(function(){
  try{
    // 1) Ensure/resume AudioContext on first user gesture
    if (!window.__audioInit) {
      window.__audioInit = true;
      window.A = window.A || new (window.AudioContext || window.webkitAudioContext)();
      window.audioReady = false;

      function ensureAudio(){
        try{
          if (!window.A) window.A = new (window.AudioContext || window.webkitAudioContext)();
          if (window.A && window.A.state === 'suspended') window.A.resume();
        }catch(e){}
      }
      window.ensureAudio = ensureAudio;

      window.addEventListener('pointerdown', function onceUnlock(){
        ensureAudio();
        window.audioReady = true;
      }, { once:true, passive:true });

      document.addEventListener('visibilitychange', function(){
        if (document.visibilityState === 'visible' && window.A && window.A.state === 'suspended'){
          window.A.resume();
        }
      });
    }

    // 2) Strong beep (overrides existing if any, but keeps signature)
    window.beep = function(ok=true){
      try{
        ensureAudio();
        if (!window.audioReady) return; // require first user gesture
        const a = window.A;
        const o = a.createOscillator();
        const g = a.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(ok ? 1200 : 420, a.currentTime);
        // Higher gain but safe; clamp if too high
        const gain = 0.25;
        g.gain.setValueAtTime(gain, a.currentTime);
        o.connect(g).connect(a.destination);
        o.start();
        o.stop(a.currentTime + 0.25);
      }catch(e){ /* noop */ }
    };

    // 3) Haptic helper with iOS-safe fallback
    window.strongHaptic = function(ok=true){
      try{
        const pattern = ok ? [180] : [220,80,220];
        if (navigator.vibrate) {
          navigator.vibrate(pattern);
        } else {
          // iOS: no vibrate; reinforce with a second beep only on failure
          if (!ok) window.beep(false);
        }
      }catch(e){ /* noop */ }
    };
  }catch(e){ /* totally non-breaking */ }
})();
</script>


<!-- 🔊 One-tap unlock UI -->
<div id="soundUnlockToast" class="hidden">
  <span>🔊 Sesleri etkinleştir</span>
  <button id="btnUnlockAudio">Etkinleştir</button>
</div>
<script>
(function(){
  try{
    // Show toast until unlocked once per device
    function showToast(){ document.getElementById('soundUnlockToast')?.classList.remove('hidden'); }
    function hideToast(){ document.getElementById('soundUnlockToast')?.classList.add('hidden'); }

    const LS_KEY = 'dk_audio_unlocked_v1';
    const wasUnlocked = localStorage.getItem(LS_KEY) === '1';

    function unlockAndTest(){
      try{
        ensureAudio();
        window.audioReady = true;
        localStorage.setItem(LS_KEY,'1');
        hideToast();
        // test pings: success+error to confirm
        if (typeof window.beep==='function'){ window.beep(true); setTimeout(()=>window.beep(false), 220); }
        if (typeof window.strongHaptic==='function'){ window.strongHaptic(true); setTimeout(()=>window.strongHaptic(false), 220); }
      }catch(e){}
    }

    // If not unlocked yet, present toast after load
    window.addEventListener('load', function(){
      if (!wasUnlocked){
        showToast();
      }
    });

    document.addEventListener('click', function(e){
      if (e.target && e.target.id === 'btnUnlockAudio'){
        unlockAndTest();
      }
    }, true);

    // Also auto-unlock on first pointerdown if user ignores the button
    window.addEventListener('pointerdown', function(){
      if (!localStorage.getItem(LS_KEY)){
        try{ ensureAudio(); window.audioReady = true; localStorage.setItem(LS_KEY,'1'); hideToast(); }catch(e){}
      }
    }, { once:true, passive:true });
  }catch(e){}
})();
</script>


<script>
// === Audio + Haptic Signals using external MP3s ===
function playSound(id){
  try{
    const el = document.getElementById(id);
    if(el){ el.currentTime = 0; el.play().catch(()=>{}); }
  }catch(e){}
}

function onMatch(){
  playSound('sndMatch');
  if (window.strongHaptic) strongHaptic(true);
}

function onCartAdd(){
  playSound('sndCart');
  if (window.strongHaptic) strongHaptic(true);
}

function onFail(){
  playSound('sndFail');
  if (window.strongHaptic) strongHaptic(false);
}

// Bind to common function names / events
(function(){
  function wrapIf(fnName, beforeCb){
    try{
      const fn = window[fnName];
      if (typeof fn === 'function' && !fn.__wrappedAudio){
        window[fnName] = function(){
          try{ beforeCb && beforeCb.apply(this, arguments); }catch(_){}
          return fn.apply(this, arguments);
        };
        window[fnName].__wrappedAudio = true;
      }
    }catch(e){}
  }

  ['onProductMatched','handleMatch','matchFound','urunEslesti','scanSuccess']
    .forEach(n=>wrapIf(n, onMatch));
  ['addToCart','addCart','sepeteEkle','urunSepeteEkle','handleAddToCart']
    .forEach(n=>wrapIf(n, onCartAdd));
  ['onScanFail','handleScanFail','scanFail','notFound','urunBulunamadi']
    .forEach(n=>wrapIf(n, onFail));

  // Event listeners fallback
  window.addEventListener('product:matched', ()=>onMatch(), true);
  window.addEventListener('cart:added', ()=>onCartAdd(), true);
  window.addEventListener('product:notfound', ()=>onFail(), true);
})();
</script>


<!-- 🔢 Custom Numeric Modal for +Adet -->
<div id="adetModal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:12px;max-width:300px;width:80%;text-align:center;">
    <h3 style="margin-top:0;">Kaç adet?</h3>
    <input id="adetInput" type="tel" inputmode="numeric" pattern="[0-9]*" style="width:100%;padding:10px;font-size:18px;text-align:center;" />
    <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;">
      <button id="adetCancel" style="padding:10px 20px;border:none;border-radius:8px;background:#ccc;">İptal</button>
      <button id="adetOk" style="padding:10px 20px;border:none;border-radius:8px;background:#00c853;color:#fff;">Tamam</button>
    </div>
  </div>
</div>

<script>
// === Override beep() with MP3 ===
function playSound(id){
  try{
    const el = document.getElementById(id);
    if(el){ el.currentTime = 0; el.play().catch(()=>{}); }
  }catch(e){}
}

window.beep = function(ok=true){
  if(ok===true){ playSound('sndMatch'); if(window.strongHaptic) strongHaptic(true); }
  else if(ok===false){ playSound('sndFail'); if(window.strongHaptic) strongHaptic(false); }
};

(function(){
  function wrapIf(fnName, cb){
    try{
      const fn = window[fnName];
      if(typeof fn==='function' && !fn.__wrappedCartAudio){
        window[fnName] = function(){
          try{ cb && cb.apply(this, arguments); }catch(_){}
          return fn.apply(this, arguments);
        };
        window[fnName].__wrappedCartAudio = true;
      }
    }catch(e){}
  }
  ['addToCart','addCart','sepeteEkle','urunSepeteEkle','handleAddToCart']
    .forEach(n=>wrapIf(n, ()=>playSound('sndCart')));
})();

// === Replace askAdet with custom modal ===
window.askAdet = function(callback){
  const modal = document.getElementById('adetModal');
  const input = document.getElementById('adetInput');
  const btnOk = document.getElementById('adetOk');
  const btnCancel = document.getElementById('adetCancel');
  modal.style.display='flex';
  input.value='';
  setTimeout(()=>{ input.focus(); }, 50);

  function close(){
    modal.style.display='none';
    btnOk.onclick=null; btnCancel.onclick=null;
  }

  btnOk.onclick=function(){
    const val = (input.value||"").trim();
    close();
    // 1) Eğer ürün popup'ından geldiysek: otomatik sepete ekle + sesi çal + kamerayı aç
    const qty = parseInt(val||'0', 10);
    const p = window.__lastProduct || null;
    const old = !!window.__lastIsOld;
    if (qty>0 && p && typeof window.addToCart==='function'){
      try{
        window.addToCart(p, qty, old);
        if (typeof playSound==='function') playSound('sndCart');
      }catch(_){}
      // Ürün popup'ını kapat
      try{ const mdl = document.getElementById('mdlProduct'); if (mdl) mdl.classList.remove('shown'); }catch(_){}
      // Kamerayı tekrar aç
      try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
    }
    // 2) İsteğe bağlı: eski callback'e de sonucu geç
    if (typeof callback === 'function') { callback(val); }
  };

  btnCancel.onclick=function(){
    close();
    // Kamerayı tekrar aç (iptalde de vakit kaybetmeyelim)
    try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
    if (typeof callback === 'function') { callback(null); }
  };
};
  btnCancel.onclick=function(){ close(); callback(null); };
};
</script>


<!-- 🔢 Custom Numeric Modal for +Adet -->
<div id="adetModal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:12px;max-width:300px;width:80%;text-align:center;">
    <h3 style="margin-top:0;">Kaç adet?</h3>
    <input id="adetInput" type="tel" inputmode="numeric" pattern="[0-9]*" style="width:100%;padding:10px;font-size:18px;text-align:center;" />
    <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;">
      <button id="adetCancel" style="padding:10px 20px;border:none;border-radius:8px;background:#ccc;">İptal</button>
      <button id="adetOk" style="padding:10px 20px;border:none;border-radius:8px;background:#00c853;color:#fff;">Tamam</button>
    </div>
  </div>
</div>

<script>
function playSound(id){
  try{
    const el=document.getElementById(id);
    if(el){ el.currentTime=0; el.play().catch(()=>{}); }
  }catch(e){}
}

// Override beep()
window.beep=function(ok){
  if(ok===true){ playSound('sndMatch'); if(window.strongHaptic) strongHaptic(true); }
  else if(ok===false){ playSound('sndFail'); if(window.strongHaptic) strongHaptic(false); }
  else { playSound('sndCart'); if(window.strongHaptic) strongHaptic(true); }
};

// Replace prompt with modal
window.askAdet = function(callback){
  const modal = document.getElementById('adetModal');
  const input = document.getElementById('adetInput');
  const btnOk = document.getElementById('adetOk');
  const btnCancel = document.getElementById('adetCancel');
  modal.style.display='flex';
  input.value='';
  setTimeout(()=>{ input.focus(); }, 50);

  function close(){
    modal.style.display='none';
    btnOk.onclick=null; btnCancel.onclick=null;
  }

  btnOk.onclick=function(){
    const val = (input.value||"").trim();
    close();
    // 1) Eğer ürün popup'ından geldiysek: otomatik sepete ekle + sesi çal + kamerayı aç
    const qty = parseInt(val||'0', 10);
    const p = window.__lastProduct || null;
    const old = !!window.__lastIsOld;
    if (qty>0 && p && typeof window.addToCart==='function'){
      try{
        window.addToCart(p, qty, old);
        if (typeof playSound==='function') playSound('sndCart');
      }catch(_){}
      // Ürün popup'ını kapat
      try{ const mdl = document.getElementById('mdlProduct'); if (mdl) mdl.classList.remove('shown'); }catch(_){}
      // Kamerayı tekrar aç
      try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
    }
    // 2) İsteğe bağlı: eski callback'e de sonucu geç
    if (typeof callback === 'function') { callback(val); }
  };

  btnCancel.onclick=function(){
    close();
    // Kamerayı tekrar aç (iptalde de vakit kaybetmeyelim)
    try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
    if (typeof callback === 'function') { callback(null); }
  };
};
  btnCancel.onclick=function(){close();callback(null);};
};
</script>


<!-- ❌ Not Found Modal -->
<div id="mdlNotFound" class="modal" style="display:none;align-items:center;justify-content:center;">
  <div class="box" style="text-align:center">
    <h3>Ürün bulunamadı</h3>
    <p>Okuttuğunuz ürün sistemde yok.</p>
    <div class="actions" style="justify-content:center">
      <button id="notFoundOk" class="btn">Tamam</button>
    </div>
  </div>
</div>

<script>
(function(){
  // Show/hide not found modal
  function showNotFound(){
    try{
      const m = document.getElementById('mdlNotFound');
      if(!m) return;
      m.style.display='flex';
      document.getElementById('notFoundOk').onclick = function(){
        m.style.display='none';
        if (typeof refocusAfterAction === 'function') refocusAfterAction(true);
      };
    }catch(_){}
  }

  // Wrap findProduct to play fail sound + show modal when not found
  try{
    if (typeof window.findProduct === 'function' && !window.findProduct.__wrappedNF){
      const __origFind = window.findProduct;
      window.findProduct = function(code){
        const res = __origFind.apply(this, arguments);
        if (!res) {
          if (typeof playSound === 'function') playSound('sndFail');
          showNotFound();
        }
        return res;
      };
      window.findProduct.__wrappedNF = true;
    }
  }catch(_){}

  // Ensure btnCustom uses askAdet modal
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnCustom');
    if(btn){
      e.preventDefault(); e.stopImmediatePropagation();
      const p = window.__lastProduct || null;
      const old = (document.getElementById('mOld')?.style.display === 'block');
      if (typeof askAdet === 'function'){
        askAdet(function(val){
          const q = parseInt(val||'1', 10);
          if (q>0 && typeof window.addToCart === 'function' && p){
            window.addToCart(p, q, !!old);
          }
        });
      }
    }
  }, true);
})();
</script>


<script>
// === Fix wiring ===
(function(){
  // 1) Old Price warning proceed id is btnOldContinue (not btnOldProceed)
  try{
    const warn = $('mdlOldWarn');
    const btnCancel = $('btnOldCancel');
    const btnGo = $('btnOldContinue');
    if (btnCancel && warn){
      btnCancel.onclick = function(){
        try{
          warn.classList.remove('shown');
          if (typeof IS_PRINTING !== 'undefined') IS_PRINTING = false;
          const btn = $('btnCartPrint'); if (btn) btn.disabled = false;
        }catch(_){}
      };
    }
    if (btnGo && warn){
      btnGo.onclick = function(){
        try{
          warn.classList.remove('shown');
          const btnOldSave = $('btnPdfOldSave');
          if (btnOldSave){
            const mdlOld = $('mdlPdfOld');
            if (mdlOld) mdlOld.classList.add('shown');
            btnOldSave.click();
          } else {
            const btnSave = $('btnPdfSave');
            if (btnSave) btnSave.click();
          }
        }catch(_){}
      };
    }
  }catch(_){}

  // 2) Ensure Özel button opens numeric modal and proceeds
  try{
    const btnCustom = $('btnCustom');
    if (btnCustom){
      btnCustom.onclick = function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        if (typeof askAdet === 'function'){
          askAdet(function(val){
            const q = parseInt((val||'').trim(),10);
            const p = window.__lastProduct || null;
            const old = !!window.__lastIsOld;
            if (q>0 && p && typeof addToCart==='function'){
              addToCart(p, q, old);
              if (typeof playSound==='function') playSound('sndCart');
              try{ const mdl = $('mdlProduct'); if (mdl) mdl.classList.remove('shown'); }catch(_){}
              try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
            }
          });
        }
      };
    }
  }catch(_){}

  // 3) Numeric modal: submit on Enter/Done
  try{
    const input = document.getElementById('adetInput');
    const ok = document.getElementById('adetOk');
    if (input && ok){
      input.addEventListener('keydown', function(e){
        if (e.key === 'Enter'){
          e.preventDefault();
          ok.click();
        }
      });
    }
  }catch(_){}
})();
</script>


<script>
// Robust wiring for "Eski Fiyat Uyarısı" modal (no $ dependency)
(function(){
  try{
    const $id = (x)=>document.getElementById(x);
    const warn = $id('mdlOldWarn');
    if (!warn) return;

    let btnCancel = $id('btnOldCancel');
    let btnGo = $id('btnOldContinue');

    // Ensure buttons exist
    if (!btnCancel || !btnGo) return;

    function closeWarn(){
      warn.classList.remove('shown');
      warn.style.display = 'none';
      try{
        if (typeof IS_PRINTING !== 'undefined') IS_PRINTING = false;
        const btn = $id('btnCartPrint') || $id('btnPrint');
        if (btn) btn.disabled = false;
      }catch(_){}
    }

    // Remove existing listeners by replacing with clones (avoids duplicate handlers)
    function resetNode(el){
      if (!el || !el.parentNode) return el;
      const c = el.cloneNode(true);
      el.parentNode.replaceChild(c, el);
      return c;
    }
    btnCancel = resetNode(btnCancel);
    btnGo = resetNode(btnGo);

    btnCancel.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      closeWarn();
    }, true);

    btnGo.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      // Kick off PDF flow reliably
      const oldSave = $id('btnPdfOldSave');
      const oldMdl = $id('mdlPdfOld');
      if (oldMdl) oldMdl.classList.add('shown');
      if (oldSave) {
        oldSave.click();
      } else {
        const save = $id('btnPdfSave');
        if (save) save.click();
      }
      closeWarn();
    }, true);

    // Overlay click closes
    warn.addEventListener('click', function(e){
      if (e.target === warn) closeWarn();
    }, true);

    // ESC closes
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && warn.classList.contains('shown')) closeWarn();
    });
  }catch(_){}
})();
</script>


<!-- DK: Merkezi Uyarı Modalı -->
<div id="mdlNf" class="modal"><div class="box" id="nfBox">
  <h3 id="nfTitle">Barkod Bulunamadı</h3>
  <div class="mini" id="nfMsg">Okutulan: <b id="nfCode">—</b></div>
  <div class="actions" style="justify-content:flex-end">
    <button id="btnNfClose" class="btn">Kapat</button>
  </div>
</div></div>

</body>
</html>

<script>
(function(){
  function installInlineAdder(btn){
    if (!btn || btn.__patchedInline) return;
    btn.__patchedInline = true;
    btn.style.display = 'none';

    var wrap = document.createElement('span');
    wrap.style.display = 'inline-flex';
    wrap.style.alignItems = 'center';
    wrap.style.gap = '8px';
    wrap.style.marginLeft = '6px';

    var inp = document.createElement('input');
    inp.id = 'qtyCustomInline';
    inp.type = 'tel';
    inp.setAttribute('inputmode','numeric');
    inp.setAttribute('pattern','[0-9]*');
    inp.placeholder = 'Adet';
    inp.style.width = '80px';
    inp.style.textAlign = 'center';
    inp.style.padding = '8px 10px';
    inp.style.fontSize = '16px';
    inp.style.border = '1px solid #ccc';
    inp.style.borderRadius = '10px';

    var plus = document.createElement('button');
    plus.className = 'btn';
    plus.id = 'btnInlineAdd';
    plus.textContent = '+';

    var confirm = document.createElement('button');
    confirm.className = 'btn';
    confirm.id = 'btnInlineConfirm';
    confirm.textContent = 'Onayla';
    confirm.style.background = '#28a745';
    confirm.style.color = '#fff';
    confirm.style.fontWeight = '600';

    wrap.appendChild(inp);
    wrap.appendChild(plus);
    wrap.appendChild(confirm);
    btn.parentNode.insertBefore(wrap, btn.nextSibling);

    function onlyDigits(s){ return (s||'').replace(/[^\d]/g,''); }
    function parseQty(){ return parseInt(onlyDigits(inp && inp.value), 10) || 0; }
    function safeAdd(q){
      try{
        var p = window.__lastProduct || null;
        var old = !!window.__lastIsOld;
        if (q>0 && p && typeof window.addToCart==='function'){
          window.addToCart(p, q, old);
          try{ if (typeof playSound==='function') playSound('sndCart'); }catch(_){}
          try{ var mdl=document.getElementById('mdlProduct'); if(mdl) mdl.classList.remove('shown'); }catch(_){}
          try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
        }
      }catch(_){}
    }

    inp.addEventListener('input', function(){ this.value = onlyDigits(this.value); }, true);
    inp.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){ e.preventDefault(); safeAdd(parseQty()); }
    }, true);

    plus.addEventListener('click', function(e){ e.preventDefault(); safeAdd(parseQty()); }, true);
    confirm.addEventListener('click', function(e){ e.preventDefault(); safeAdd(parseQty()); }, true);
  }

  function tryPatch(){ var b=document.getElementById('btnCustom'); if (b) installInlineAdder(b); }
  document.addEventListener('DOMContentLoaded', tryPatch);
  var obs=new MutationObserver(function(){ tryPatch(); });
  obs.observe(document.documentElement||document.body,{childList:true,subtree:true});
})();
</script>

<script>
// Runtime replacement for "Özel" button -> "+ [adet kutusu]"
(function(){
  function installInlineAdder(btn){
    if (!btn || btn.__patchedInline) return;
    btn.__patchedInline = true;
    // Hide original "Özel" button
    btn.style.display = 'none';

    // Build inline controls
    var wrap = document.createElement('span');
    wrap.style.display = 'inline-flex';
    wrap.style.alignItems = 'center';
    wrap.style.gap = '8px';
    wrap.style.marginLeft = '6px';

    var plus = document.createElement('button');
    plus.className = 'btn';
    plus.id = 'btnInlineAdd';
    plus.textContent = '+';
    plus.style.padding = '8px 12px';
    plus.style.fontWeight = '700';

    var inp = document.createElement('input');
    inp.id = 'qtyCustomInline';
    inp.type = 'tel';
    inp.setAttribute('inputmode', 'numeric');
    inp.setAttribute('pattern', '[0-9]*');
    inp.placeholder = 'Adet';
    inp.style.width = '100px';
    inp.style.textAlign = 'center';
    inp.style.padding = '8px 10px';
    inp.style.fontSize = '16px';
    inp.style.border = '1px solid #ccc';
    inp.style.borderRadius = '10px';

    wrap.appendChild(plus);
    wrap.appendChild(inp);
    // Insert after the old button
    btn.parentNode.insertBefore(wrap, btn.nextSibling);

    function onlyDigits(s){ return (s||'').replace(/[^\d]/g,''); }
    function parseQty(){ return parseInt(onlyDigits(inp && inp.value), 10) || 0; }
    function safeAdd(q){
      try{
        var p = window.__lastProduct || null;
        var old = !!window.__lastIsOld;
        if (q>0 && p && typeof window.addToCart==='function'){
          window.addToCart(p, q, old);
          try{ if (typeof playSound==='function') playSound('sndCart'); }catch(_){}
          try{ var mdl=document.getElementById('mdlProduct'); if(mdl) mdl.classList.remove('shown'); }catch(_){}
          try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
        }
      }catch(_){}
    }

    inp.addEventListener('input', function(){ this.value = onlyDigits(this.value); }, true);
    inp.addEventListener('focus', function(){ try{ this.select(); }catch(_){} }, true);
    inp.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){
        e.preventDefault();
        safeAdd(parseQty());
      }
    }, true);

    plus.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      safeAdd(parseQty());
    }, true);
  }

  // Try immediately
  function tryPatch(){ var b=document.getElementById('btnCustom'); if (b) installInlineAdder(b); }
  document.addEventListener('DOMContentLoaded', tryPatch);

  // Observe for modal/content updates (e.g., popup açıldığında buton ekleniyorsa)
  var obs = new MutationObserver(function(){
    tryPatch();
  });
  obs.observe(document.documentElement || document.body, { childList: true, subtree: true });
})();
</script>

<script>
// STRONG OVERRIDE: wire inline onclick on the injected buttons so nothing can block them.
(function(){
  function install(){
    var wrapBtn = document.getElementById('btnCustom');
    if (!wrapBtn) return;

    // If our inline controls already exist, hard-wire their onclicks
    var plus = document.getElementById('btnInlineAdd');
    var confirm = document.getElementById('btnInlineConfirm');
    var input = document.getElementById('qtyCustomInline');

    function onlyDigits(s){ return (s||'').replace(/[^\d]/g,''); }
    function parseQty(){ return parseInt(onlyDigits(input && input.value), 10) || 0; }
    function safeAdd(q){
      try{
        var p = window.__lastProduct || null;
        var old = !!window.__lastIsOld;
        if (q>0 && p && typeof window.addToCart==='function'){
          window.addToCart(p, q, old);
          try{ if (typeof playSound==='function') playSound('sndCart'); }catch(_){}
          try{ var mdl=document.getElementById('mdlProduct'); if(mdl) mdl.classList.remove('shown'); }catch(_){}
          try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
        }
      }catch(_){}
    }

    if (input){
      input.style.pointerEvents = 'auto';
      input.onkeydown = function(e){ if(e.key==='Enter'){ e.preventDefault(); safeAdd(parseQty()); return false; } };
    }

    if (plus){
      plus.setAttribute('type','button');
      plus.style.pointerEvents = 'auto';
      plus.onclick = function(e){ if(e){e.preventDefault(); e.stopPropagation();} safeAdd(parseQty()); return false; };
    }

    if (confirm){
      confirm.setAttribute('type','button');
      confirm.style.pointerEvents = 'auto';
      // Force highest z-index in the row to avoid overlay swallowing clicks
      confirm.style.zIndex = 99999;
      confirm.onclick = function(e){ if(e){e.preventDefault(); e.stopPropagation();} safeAdd(parseQty()); return false; };
    }
  }

  // Try now and whenever DOM changes
  document.addEventListener('DOMContentLoaded', install);
  var obs = new MutationObserver(install);
  obs.observe(document.documentElement||document.body, {childList:true, subtree:true});
})();
</script>

<script>
(function(){
  const CAP_OPTS = { capture: true, passive: false };
  function onlyDigits(s){ return (s||'').replace(/[^\d]/g,''); }

  function ensureInlineControls(){
    try{
      const modal = document.getElementById('mdlProduct');
      if (!modal) return;
      const actions = modal.querySelector('.actions');
      if (!actions) return;

      const oldCustom = actions.querySelector('#btnCustom');
      if (oldCustom) oldCustom.style.display = 'none';

      if (actions.querySelector('#qtyCustomInline')) return;

      const wrap = document.createElement('span');
      wrap.style.display='inline-flex';
      wrap.style.alignItems='center';
      wrap.style.gap='8px';
      wrap.style.marginLeft='6px';

      const inp = document.createElement('input');
      inp.id='qtyCustomInline';
      inp.type='tel';
      inp.setAttribute('inputmode','numeric');
      inp.setAttribute('pattern','[0-9]*');
      inp.placeholder='Adet';
      inp.style.width='84px';
      inp.style.textAlign='center';
      inp.style.padding='8px 10px';
      inp.style.fontSize='16px';
      inp.style.border='1px solid #ccc';
      inp.style.borderRadius='10px';

      const plus = document.createElement('button');
      plus.className='btn';
      plus.id='btnInlineAdd';
      plus.type='button';
      plus.textContent='+';

      const ok = document.createElement('button');
      ok.className='btn';
      ok.id='btnInlineConfirm';
      ok.type='button';
      ok.textContent='Onayla';
      ok.style.background='#28a745';
      ok.style.color='#fff';
      ok.style.fontWeight='600';

      wrap.appendChild(plus);
      wrap.appendChild(inp);
      wrap.appendChild(ok);

      const oneBtn = actions.querySelector('#btnQty1') || actions.firstElementChild;
      if (oneBtn && oneBtn.nextSibling){
        actions.insertBefore(wrap, oneBtn.nextSibling);
      } else {
        actions.appendChild(wrap);
      }

      setTimeout(()=>{try{inp.focus();inp.select();}catch(_){}} ,50);
    }catch(_){}
  }

  function safeAddFromInput(){
    try{
      const inp = document.getElementById('qtyCustomInline');
      const q = parseInt(onlyDigits(inp && inp.value),10) || 0;
      const p = window.__lastProduct || null;
      const old = !!window.__lastIsOld;
      if (q>0 && p && typeof window.addToCart==='function'){
        window.addToCart(p, q, old);
        try{ if (typeof playSound==='function') playSound('sndCart'); }catch(_){}
        try{ const mdl = document.getElementById('mdlProduct'); if (mdl) mdl.classList.remove('shown'); }catch(_){}
        try{ if (typeof refocusAfterAction==='function') refocusAfterAction(true); }catch(_){}
      }
    }catch(_){}
  }

  document.addEventListener('click', function(ev){
    const t = ev.target;
    if (!t) return;
    if (t.id === 'btnInlineAdd' || t.id === 'btnInlineConfirm'){
      ev.preventDefault(); ev.stopPropagation();
      safeAddFromInput();
    }
  }, CAP_OPTS);

  document.addEventListener('keydown', function(ev){
    const t = ev.target;
    if (!t) return;
    if (t.id === 'qtyCustomInline' && ev.key === 'Enter'){
      ev.preventDefault(); ev.stopPropagation();
      safeAddFromInput();
    }
  }, CAP_OPTS);

  document.addEventListener('input', function(ev){
    const t = ev.target;
    if (t && t.id === 'qtyCustomInline'){
      t.value = onlyDigits(t.value);
    }
  }, CAP_OPTS);

  document.addEventListener('DOMContentLoaded', ensureInlineControls);
  const obs = new MutationObserver(ensureInlineControls);
  obs.observe(document.documentElement || document.body, { childList:true, subtree:true });
})();
</script>
