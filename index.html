<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Fiyat Gör • Etiket Bas (v2)</title>
<style>
:root{--bg:#0b1020;--card:#121a35;--muted:#7d8db1;--accent:#4f8cff;--good:#19c37d;--warn:#ffb020;--bad:#ff4d4d}
*{box-sizing:border-box} body{margin:0;background:#0b1020;color:#eef2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
header{position:sticky;top:0;background:linear-gradient(180deg,#0b1020 0%,rgba(11,16,32,.9) 100%);backdrop-filter:blur(8px);z-index:30;border-bottom:1px solid #1f2a4d}
.container{max-width:980px;margin:0 auto;padding:16px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid #1f2a4d;border-radius:16px;padding:14px}
.btn{appearance:none;border:none;border-radius:14px;padding:12px 14px;background:#1a2752;color:#e6ecff;font-weight:600;cursor:pointer}
.btn.primary{background:var(--accent)} .btn.good{background:var(--good)} .btn.warn{background:var(--warn);color:#0b0b0b} .btn.bad{background:var(--bad)}
.btn.block{width:100%}
.muted{color:var(--muted)}
video{width:100%;border-radius:16px;border:1px solid #2a396d;background:#000}
.pill{display:inline-flex;align-items:center;gap:6px;background:#0f1834;border:1px solid #28376d;border-radius:999px;padding:6px 10px;font-size:12px}
.grid{display:grid;grid-template-columns:1fr;gap:8px}
.sepet-list{max-height:240px;overflow:auto;border:1px dashed #2a396d;border-radius:12px;padding:10px}
.sepet-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #2a396d}
.sepet-item:last-child{border-bottom:none}
input[type="number"],input[type="text"]{width:100%;background:#0b132b;border:1px solid #27356d;border-radius:12px;padding:10px;color:#e6ecff}
label{font-size:12px;color:#9fb2e2}
dialog{border:none;border-radius:16px;background:#0f1834;color:#e6ecff;padding:0;max-width:480px;width:calc(100% - 24px)}
dialog::backdrop{background:rgba(0,0,0,.6)}
.modal-head{padding:12px 14px;border-bottom:1px solid #27356d;font-weight:700}
.modal-body{padding:14px}
.modal-foot{padding:12px 14px;border-top:1px solid #27356d;display:flex;gap:8px;justify-content:flex-end}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f1834;border:1px solid #28376d;border-radius:8px;padding:2px 6px}
footer{color:#6e7fa9;font-size:12px;padding:20px 0;text-align:center}
#status{font-size:12px}
</style>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <div class="container row" style="align-items:center;justify-content:space-between">
    <div class="row" style="align-items:center">
      <img id="logoTop" src="assets/logo.png" alt="Logo" style="height:28px;width:auto"/>
      <div style="font-weight:800;margin-left:8px">Fiyat Gör • Etiket Bas (v2)</div>
    </div>
    <div id="status" class="muted">Hazır</div>
  </div>
</header>

<main class="container grid" style="margin-top:12px">
  <section class="card">
    <div style="font-weight:700;margin-bottom:6px">Veri Kaynağı</div>
    <div class="grid">
      <div class="row">
        <button id="btnSheets" class="btn">Sheets’ten Al</button>
        <button id="btnFile" class="btn">Excel/CSV Seç</button>
        <button id="btnSample" class="btn warn">Test Verisi</button>
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" style="display:none"/>
      </div>
      <div class="grid">
        <label>Google Sheets Ayarları</label>
        <div class="row">
          <input id="sheetsId" placeholder="Sheets ID" />
          <input id="sheetName" placeholder="Sayfa adı (Sheet1)" />
        </div>
        <input id="appsScriptUrl" placeholder="Apps Script WebApp URL (JSON, public)" />
        <div class="muted">
          Beklenen alanlar: <span class="kbd">Barkod</span>, <span class="kbd">Stok Adı</span>, <span class="kbd">Fiyat</span>, <span class="kbd">Fiyat Değişiklik Tarihi</span>.
        </div>
      </div>
      <div class="muted" id="lastError"></div>
    </div>
  </section>

  <section class="card grid">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="row" style="align-items:center">
        <button id="btnOpenCam" class="btn primary">Kamerayı Aç</button>
        <button id="btnCloseCam" class="btn bad">Kapat</button>
        <button id="btnManual" class="btn">Elle Barkod</button>
      </div>
      <div class="pill">EAN-13 / UPC-A</div>
    </div>
    <video id="video" playsinline muted></video>
    <div class="muted">Okuma → pop-up → sepet; kapanınca kamera otomatik yeniden başlar.</div>
  </section>

  <section class="card grid">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div style="font-weight:700">Sepet</div>
      <div class="row">
        <button id="btnClear" class="btn">Temizle</button>
        <button id="btnPrint" class="btn good">PDF Yazdır</button>
      </div>
    </div>
    <div id="sepetList" class="sepet-list"></div>
  </section>
</main>

<footer>© <span id="yil"></span> Demir Kırtasiye</footer>

<dialog id="dlgUrun">
  <form method="dialog">
    <div class="modal-head">Ürün bulundu</div>
    <div class="modal-body">
      <div><b id="mStokAdi">-</b></div>
      <div class="row" style="margin:8px 0 6px">
        <div class="pill">Barkod: <span id="mBarkod"></span></div>
        <div class="pill">Fiyat: <span id="mFiyat"></span></div>
      </div>
      <div>
        <label>Adet</label>
        <input id="mAdet" type="number" min="1" value="1"/>
      </div>
      <div id="mEski" class="muted" style="margin-top:6px"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" value="cancel">İptal</button>
      <button class="btn good" value="ok">Sepete Ekle</button>
    </div>
  </form>
</dialog>

<script>
const S = {
  dataset: new Map(),
  sepet: [],
  codeReader: null,
  cameraOn: false,
  logoDataUrl: null
};
document.getElementById('yil').textContent = new Date().getFullYear();
function setStatus(t){ document.getElementById('status').textContent = t; }
function setErr(t){ document.getElementById('lastError').textContent = t||''; }
function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='square';o.frequency.value=900;o.connect(g);g.connect(ctx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.1); setTimeout(()=>{o.stop();ctx.close()},160);}catch(e){} }
function vibrate(){ if(navigator.vibrate) navigator.vibrate([30]); }
function fmtPrice(p){ if(!isFinite(p)) return '-'; return p.toLocaleString('tr-TR',{style:'currency',currency:'TRY'}); }
function normDate(s){
  if(!s) return null; s=String(s).trim();
  let d=null; const m1=s.match(/^(\d{1,2})[\/\.\-](\d{1,2})[\/\.\-](\d{2,4})$/); const m2=s.match(/^(\d{4})[\/\.\-](\d{1,2})[\/\.\-](\d{1,2})$/);
  if(m1){ const dd=+m1[1], mm=+m1[2]-1, yy=+m1[3]<100?2000+(+m1[3]):+m1[3]; d=new Date(yy,mm,dd); }
  else if(m2){ d=new Date(+m2[1],+m2[2]-1,+m2[3]); }
  else{ const t=Date.parse(s); if(!isNaN(t)) d=new Date(t); }
  return d;
}
function mapRow(row){
  const keys=Object.keys(row);
  const pick=(...opts)=>{
    for(const k of keys){ const nk=k.trim().toLowerCase(); if(opts.some(o=>nk.includes(o))) return row[k]; }
    return undefined;
  };
  const ean=String(pick('barkod','ean','ean13','barcode')||'').replace(/[^\d]/g,'');
  const name=String(pick('stok adı','stok adi','ürün','urun','product','name')||'').trim();
  const priceRaw=pick('fiyat','price');
  const fdRaw=pick('fiyat değişiklik','fiyat degisim','fd','price change','last update','son günc');
  const price=parseFloat(String(priceRaw||'').replace(',','.').replace(/[^\d.]/g,''));
  const lastPriceDate=normDate(fdRaw);
  return ean? {ean,name,price,lastPriceDate} : null;
}
function addToDataset(rows){
  let added=0;
  rows.forEach(r=>{ const m=mapRow(r); if(m && m.ean.length>=12){ S.dataset.set(m.ean,m); if(m.ean.length===12){ S.dataset.set('0'+m.ean,m); } added++; } });
  setStatus(`Yüklendi • ${S.dataset.size} ürün`);
}
function renderSepet(){
  const el=document.getElementById('sepetList'); el.innerHTML='';
  S.sepet.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='sepet-item';
    row.innerHTML=`<div class="grow"><div style="font-weight:600">${it.name||'-'}</div>
      <div class="muted">EAN: <span class="kbd">${it.ean}</span> • Fiyat: ${fmtPrice(it.price)} • Adet: ${it.adet}</div></div>
      <button class="btn bad" data-idx="${idx}">Sil</button>`;
    row.querySelector('button').onclick=()=>{ S.sepet.splice(idx,1); renderSepet(); };
    el.appendChild(row);
  });
}

// ---- Data: Excel/CSV ----
document.getElementById('btnFile').onclick=()=> document.getElementById('fileInput').click();

async function readWorkbook(file){
  // Robust fallback: arrayBuffer -> binaryString
  try{
    const ab = await file.arrayBuffer();
    return XLSX.read(ab, {type:'array'});
  }catch(e1){
    setErr('arrayBuffer desteklenmedi, binary fallback denenecek.');
    const bin = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsBinaryString(file); });
    return XLSX.read(bin, {type:'binary'});
  }
}

document.getElementById('fileInput').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  setStatus('Dosya okunuyor...'); setErr('');
  try{
    if(/\.(csv)$/i.test(f.name)){
      Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{ addToDataset(res.data); }});
    }else{
      const wb = await readWorkbook(f);
      const sh = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sh, {defval:''});
      addToDataset(json);
    }
  }catch(err){
    console.error(err); setErr('Excel/CSV okunamadı: '+(err.message||err));
    setStatus('Hata');
  }
});

// ---- Data: Sample ----
document.getElementById('btnSample').onclick = async ()=>{
  setStatus('Test verisi yükleniyor...'); setErr('');
  try{
    const r = await fetch('ornek_veri.csv'); // same-origin file; works hem http hem file
    const text = await r.text();
    Papa.parse(text, {header:true, complete:(res)=> addToDataset(res.data)});
  }catch(err){ setErr('Test verisi okunamadı: '+(err.message||err)); setStatus('Hata'); }
};

// ---- Data: Google Sheets ----
document.getElementById('btnSheets').onclick = async ()=>{
  const apps = document.getElementById('appsScriptUrl').value.trim();
  const sid = document.getElementById('sheetsId').value.trim();
  const sname = document.getElementById('sheetName').value.trim() || 'Sheet1';
  setErr(''); setStatus('Sheets okunuyor...');

  // 1) Apps Script JSON (en sağlıklı yol)
  if(apps){
    try{
      const r = await fetch(apps, {method:'GET'});
      if(!r.ok) throw new Error('Apps Script erişilemedi (HTTP '+r.status+')');
      const data = await r.json();
      const rows = Array.isArray(data) ? data : (Array.isArray(data.rows)? data.rows : null);
      if(!rows) throw new Error('Beklenen JSON dizisi bulunamadı.');
      addToDataset(rows); return;
    }catch(err){
      console.warn(err); setErr('Apps Script başarısız: '+(err.message||err));
    }
  }

  // 2) CSV export (CORS gerektirir)
  if(!sid){ setErr('Sheets ID boş. Apps Script URL ya da CSV yolu kullanın.'); setStatus('Hazır'); return; }
  try{
    const url = `https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sname)}`;
    const r = await fetch(url); // CORS politikasına takılabilir
    if(!r.ok) throw new Error('CSV export erişilemedi (HTTP '+r.status+')');
    const text = await r.text();
    Papa.parse(text,{header:true,complete:(res)=> addToDataset(res.data)});
  }catch(err){
    console.error(err);
    setErr('CSV export başarısız. Bu genelde CORS kaynaklıdır. Çözüm: sayfayı bir HTTP sunucudan çalıştırın veya Apps Script JSON yolunu kullanın.');
    setStatus('Hata');
  }
};

// ---- Camera ----
const video=document.getElementById('video');
async function startCamera(){
  window.__requestCameraResume = startCamera;
  if(S.cameraOn) return;
  try{
    const hints=new Map(); hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.UPC_A]);
    S.codeReader = new ZXing.BrowserMultiFormatReader(hints);
    S.cameraOn=true; setStatus('Kamera açık: okuma bekleniyor...');
    await S.codeReader.decodeFromVideoDevice(null, video, (result)=>{
      if(result){ onDetected(result.getText? result.getText(): result.text); }
    });
  }catch(err){ console.error(err); setErr('Kamera açılamadı. İzinleri kontrol edin.'); setStatus('Hata'); S.cameraOn=false; }
}
async function stopCamera(){
  try{ if(S.codeReader){ S.codeReader.reset(); } const s=video.srcObject; if(s){ s.getTracks().forEach(t=>t.stop()); video.srcObject=null; } }catch(e){}
  S.cameraOn=false; setStatus('Kamera kapalı');
}
function onDetected(text){
  window.__resumeAfter = true;
  const ean=String(text||'').replace(/[^\d]/g,'');
  if(ean.length<12) return;
  stopCamera(); beep(); vibrate();
  const rec=S.dataset.get(ean);
  const dlg=document.getElementById('dlgUrun');
  document.getElementById('mBarkod').textContent=ean;
  if(rec){
    document.getElementById('mStokAdi').textContent=rec.name||'-';
    document.getElementById('mFiyat').textContent=fmtPrice(rec.price);
    let warn=''; if(rec.lastPriceDate){ const days=(Date.now()-rec.lastPriceDate.getTime())/86400000; if(days>365){ warn='⚠️ Bu ürünün fiyatı 12 aydan eski! Yöneticinize bilgi verin!'; } }
    document.getElementById('mEski').textContent=warn;
  }else{
    document.getElementById('mStokAdi').textContent='Kayıt bulunamadı'; document.getElementById('mFiyat').textContent='-'; document.getElementById('mEski').textContent='';
  }
  document.getElementById('mAdet').value=1;
  dlg.returnValue=''; dlg.showModal();
  dlg.onclose=()=>{
    if(dlg.returnValue==='ok' && rec){
      const adet=Math.max(1, parseInt(document.getElementById('mAdet').value||'1',10));
      S.sepet.push({ean, name: rec.name, price: rec.price, adet, lastPriceDate: rec.lastPriceDate});
      renderSepet();
    }
    if(window.__resumeAfter && typeof window.__requestCameraResume==='function'){
      window.__resumeAfter=false; setTimeout(()=>window.__requestCameraResume(), 120);
    }
  };
}
document.getElementById('btnOpenCam').onclick=startCamera;
document.getElementById('btnCloseCam').onclick=stopCamera;
document.getElementById('btnManual').onclick=()=>{ const ean=prompt('EAN-13 barkod girin:'); if(ean) onDetected(ean); }
document.getElementById('btnClear').onclick=()=>{ S.sepet=[]; renderSepet(); };

// ---- PDF ----
document.getElementById('btnPrint').onclick=async ()=>{
  if(S.sepet.length===0){ alert('Sepet boş'); return; }
  const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'mm',format:'a4',compress:true});
  const page={w:210,h:297}; const cols=3,rows=8; const margin={x:8,y:8}; const gutter={x:4,y:4};
  const cellW=(page.w-margin.x*2-gutter.x*(cols-1))/cols; const cellH=(page.h-margin.y*2-gutter.y*(rows-1))/rows;

  async function getLogo(){ try{ if(S.logoDataUrl) return S.logoDataUrl; const r=await fetch('assets/logo.png'); const b=await r.blob(); const fr=new FileReader(); const p=new Promise(res=>{fr.onload=()=>res(fr.result)}); fr.readAsDataURL(b); S.logoDataUrl=await p; return S.logoDataUrl; }catch(e){return null;} }
  const logo=await getLogo();

  const items=[]; S.sepet.forEach(it=>{ for(let i=0;i<it.adet;i++) items.push(it); });
  let x=margin.x,y=margin.y,c=0,r=0,printed=0,oldCount=0;

  function addLabel(it){
    if(logo){ try{ doc.addImage(logo,'PNG',x+2.5,y+2,16,6);}catch(_){} }
    doc.setFont('helvetica','bold'); doc.setFontSize(9.5);
    doc.text(doc.splitTextToSize(String(it.name||'-'), cellW-10), x+5, y+12);
    doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text((new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY'})).format(it.price), x+5, y+20);
    const cv=document.createElement('canvas'); JsBarcode(cv, it.ean, {format:(/^\d{13}$/.test(it.ean)?'EAN13':'CODE128'), width:1.6, height:18, displayValue:false, margin:0});
    doc.addImage(cv.toDataURL('image/png'),'PNG',x+5,y+22,Math.min(cellW-10,60),18);
    doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(it.ean, x+cellW/2, y+22+18+5, {align:'center'});
    if(it.lastPriceDate && (Date.now()-it.lastPriceDate.getTime())/86400000>365) oldCount++;
    printed++;
  }

  for(const it of items){
    addLabel(it); c++; if(c<cols){ x+=cellW+gutter.x; } else { c=0; x=margin.x; r++; if(r<rows){ y+=cellH+gutter.y; } else { r=0; y=margin.y; doc.addPage(); } }
  }

  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  doc.text(`Toplam etiket: ${printed} • Eski fiyatlı: ${oldCount}`, page.w-8, page.h-6, {align:'right'});
  doc.save('etiketler.pdf');
  if(oldCount>0){ setTimeout(()=>alert('Fiyat değişiklik tarihi eski olan ürünlerin PDF’si oluşturuldu. LÜTFEN GRUBA GÖNDERİN.'), 200); }
};

setStatus('Hazır. Test için “Test Verisi”ne bas, sonra kamerayı dene.'); renderSepet();
</script>
</body>
</html>
